<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elysia â€” åˆ†ç»„æ’­æ”¾å™¨ï¼ˆpiano é»˜è®¤ï¼‰</title>
<style>
/* ========== åŸºç¡€ & ä½ çš„åŸå§‹æ ·å¼ï¼ˆä¿ç•™å¹¶å¢å¼ºï¼‰ ========== */

/* ====== åŸºç¡€ï¼šæ¶²æ€ç»ç’ƒæ’­æ”¾å™¨ï¼ˆæ­¤å…ƒç´ ä¹Ÿä¼šè¢«æœ€å°åŒ–ä¸º 50px çƒä½“ï¼‰ ====== */
.elysia-player {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 8px 20px;
  border-radius: 16px;
  z-index: 9999;
  background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
  border: 1px solid rgba(255,255,255,0.15);
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(150,110,240,0.25), inset 0 1px 0 rgba(255,255,255,0.08);
  transition:
    width .45s cubic-bezier(.2,.9,.2,1),
    height .45s cubic-bezier(.2,.9,.2,1),
    border-radius .45s cubic-bezier(.2,.9,.2,1),
    padding .45s cubic-bezier(.2,.9,.2,1),
    transform .45s cubic-bezier(.2,.9,.2,1),
    opacity .45s ease,
    left .45s cubic-bezier(.2,.9,.2,1),
    bottom .45s cubic-bezier(.2,.9,.2,1);
  will-change: transform, width, height, opacity;
  cursor: grab;
  user-select: none;
}

/* çƒä½“æœ€å°åŒ–çŠ¶æ€æ ·å¼ï¼ˆ50pxï¼Œåœ†ï¼‰ */
.elysia-player.collapsed {
  width: 50px !important;
  height: 50px !important;
  padding: 4px !important;
  border-radius: 50% !important;
  gap: 0;
  justify-content: center;
  box-shadow: 0 8px 30px rgba(160,120,255,0.16), inset 0 2px 10px rgba(255,255,255,0.12);
  background: radial-gradient(120% 100% at 20% 30%, rgba(180,140,255,0.22), rgba(170,120,255,0.14));
}

/* å½“æ‹–æ‹½æ—¶è§†è§‰åé¦ˆ */
.elysia-player.dragging { cursor: grabbing; transform: none !important; transition: none !important; }

/* çƒä½“å†…å…‰æ•ˆï¼ˆåŠ å¼ºæ¶²æ€æ„Ÿï¼‰ */
.elysia-player::before {
  content: "";
  position: absolute;
  inset: -30%;
  background:
    radial-gradient(40% 40% at 10% 30%, rgba(156,107,255,0.45), transparent 20%),
    radial-gradient(30% 30% at 70% 20%, rgba(180,120,255,0.32), transparent 18%),
    radial-gradient(35% 35% at 40% 70%, rgba(140,200,255,0.18), transparent 22%);
  filter: blur(36px);
  opacity: 0.98;
  animation: moveBlobs 12s ease-in-out infinite;
  pointer-events: none;
  mix-blend-mode: screen;
}

/* æ§åˆ¶æŒ‰é’®ï¼ˆä¿ç•™ï¼‰ */
.elysia-controls { display:flex; gap:10px; }
.elysia-controls button {
  width: 32px; height: 32px; border-radius: 50%;
  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2);
  color: #fff; cursor: pointer; transition: all .25s ease; backdrop-filter: blur(6px);
}
.elysia-controls button:hover { transform: scale(1.08); box-shadow: 0 0 12px rgba(160,120,255,0.4); }

/* æ­Œæ›²åï¼ˆåœ¨ collapsed çŠ¶æ€éšè—ï¼Œä»…åœ¨å±•å¼€æ˜¾ç¤ºï¼‰ */
#songTitle {
  color: #f2eaff; font-weight:600; width:200px; font-size:0.95rem;
  text-shadow:0 0 10px rgba(160,120,255,0.45);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;
  will-change: transform;
}
.elysia-player.collapsed #songTitle { display: none; }

/* === æ’­æ”¾åˆ—è¡¨ï¼ˆåŸå§‹æ ·å¼ä¿ç•™ï¼Œå¹¶åœ¨åé¢æ·»åŠ  group wrapperï¼‰ === */
/* å…³é”®ï¼štransform-origin è®¾ç½®ä¸ºåº•éƒ¨ä¸­å¿ƒï¼Œè¿™æ ·ç¼©æ”¾çœ‹èµ·æ¥åƒå¾€æ’­æ”¾å™¨ä½ç½®æ”¶å› */
.elysia-playlist {
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%) scale(0.98);
  transform-origin: 50% 100%;
  width: 260px;
  max-height: 260px;
  padding: 10px 14px;
  border-radius: 16px;
  background: rgba(255,240,255,0.25);
  border: 1px solid rgba(255,210,255,0.35);
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  box-shadow: 0 8px 24px rgba(200,160,255,0.25), inset 0 1px 0 rgba(255,255,255,0.2);
  overflow-y: auto;
  opacity: 0; pointer-events: none;
  transition: opacity .35s ease, transform .45s cubic-bezier(.2,.9,.2,1);
  z-index: 9998;
  will-change: transform, opacity;
}

/* æ­Œæ›²åæ–‡å­—é¢œè‰²è°ƒæ•´ä¸ºæ·¡ç´«è‰²è°ƒ */
.playlist-item {
  padding: 6px 10px;
  color: #cdbaff; /* æ›´äº®çš„æ·¡ç´«è‰²æ–‡å­— */
  font-size: 0.9rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.playlist-item:hover {
  background: rgba(160, 120, 255, 0.15);
  color: #ffffff; /* æ‚¬åœæ—¶å˜äº® */
}

.playlist-item.active {
  background: rgba(160, 120, 255, 0.25);
  color: #fff;
  box-shadow: 0 0 12px rgba(160, 120, 255, 0.6);
  animation: softPulse 3s ease-in-out infinite;
}
/* ä¸­ç­‰é¡¹ */
@keyframes dockBounceOpen {
  0%   { transform: translateX(-50%) scale(0.75); opacity: 0; }
  55%  { transform: translateX(-50%) scale(1.08); opacity: 1; }
  75%  { transform: translateX(-50%) scale(0.97); }
  100% { transform: translateX(-50%) scale(1); }
}

@keyframes dockBounceClose {
  0%   { transform: translateX(-50%) scale(1); opacity: 1; }
  35%  { transform: translateX(-50%) scale(1.04); }
  100% { transform: translateX(-50%) scale(0.7); opacity: 0; }
}

/* å‘å…‰æ³¢çº¹å±‚ï¼ˆä½¿ç”¨ ::afterï¼‰ */
.elysia-playlist::after {
  content: ""; position: absolute; inset: 0; border-radius: 16px;
  background: radial-gradient(circle at 50% 30%, rgba(220,190,255,0.45), rgba(200,160,255,0.18) 45%, transparent 65%);
  opacity: 0; transform: scale(0.8); pointer-events: none; transition: opacity .6s ease, transform .6s ease;
}
.elysia-playlist.show::after { opacity: 1; transform: scale(1.35); }
.elysia-playlist.hide::after { opacity: 0; transform: scale(0.6); }

/* åº”ç”¨åŠ¨ç”»ç±» */
.elysia-playlist.show {
  opacity: 1; pointer-events: auto;
  animation: dockBounceOpen 0.58s cubic-bezier(0.22, 1.6, 0.36, 1) both;
  transform-origin: 50% 100%;
}
.elysia-playlist.hide {
  animation: dockBounceClose 0.48s cubic-bezier(0.3, 0, 0.7, 0.3) both;
  transform-origin: 50% 100%;
}

/* å°åŠ¨ç”» */
@keyframes moveBlobs { 0%,100%{transform:translate3d(0,0,0) scale(1.03);} 50%{transform:translate3d(4%,-3%,0) scale(1.05);} }
@keyframes softPulse { 0%,100%{box-shadow:0 0 10px rgba(160,120,255,0.4);} 50%{box-shadow:0 0 18px rgba(160,120,255,0.8);} }

/* === è½»æŸ”é£˜æµ®åŠ¨ç”»ï¼ˆElysia é£æ ¼ï¼‰ === */
@keyframes elysiaFloat {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(-6px); }
}
.elysia-player { animation: elysiaFloat 6s ease-in-out infinite; }

/* å¯è®¿é—®æ€§ä¸å¾®è°ƒ */
.elysia-playlist { scrollbar-width: thin; }
.elysia-playlist .playlist-item { outline: none; }

/* --- ADDED: group wrapper & panel styles (éç ´åæ€§è¿½åŠ ) --- */
/* wrapper that will hold group panel + playlist (mirrors original playlist position) */
#elysia_group_wrapper {
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%) scale(0.98);
  transform-origin: 50% 100%;
  display: flex;
  gap: 6px; /* keep 6px spacing */
  align-items: flex-start;
  opacity: 0;
  pointer-events: none;
  z-index: 9998;
  transition: opacity .35s ease, transform .45s cubic-bezier(.2,.9,.2,1);
}

/* show state uses existing dock animation for consistency */
#elysia_group_wrapper.show {
  opacity: 1;
  pointer-events: auto;
  animation: dockBounceOpen 0.58s cubic-bezier(0.22, 1.6, 0.36, 1) both;
}

/* left group column - now fixed 30px width as requested */
#elysia_group_panel {
  width: 30px; /* ä½ æŒ‡å®šçš„å›ºå®šå®½åº¦ */
  max-height: 260px;
  padding: 6px 4px;
  border-radius: 14px;
  background: rgba(255,240,255,0.25);
  border: 1px solid rgba(255,210,255,0.35);
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  box-shadow: 0 8px 24px rgba(200,160,255,0.18);
  display:flex;
  flex-direction: column;
  gap: 6px;
  pointer-events: auto;
  align-items:center;
  justify-content:flex-start;
  padding-top:8px;
}

#elysia_group_panel .group-item {
  width: 24px;
  height: 24px;
  line-height: 24px;
  border-radius: 6px;
  font-size: 14px;
  color: #cdbaff;
  text-align: center;
  cursor: pointer;
  transition: all .18s ease;
  display:inline-flex; align-items:center; justify-content:center;
}
#elysia_group_panel .group-item:hover { background: rgba(160,120,255,0.14); color:#fff; transform: translateY(-2px); }
#elysia_group_panel .group-item.active { background: rgba(160,120,255,0.26); color:#fff; box-shadow: 0 6px 20px rgba(160,120,255,0.25); }

/* override playlist positioning when it's inside wrapper */
#elysia_group_wrapper .elysia-playlist {
  position: static !important;
  transform: none !important;
  left: auto !important;
  bottom: auto !important;
  width: calc(260px - 30px - 6px) !important; /* ensure combined width <= 260 */
  max-height: 260px;
  margin: 0;
  pointer-events: auto;
}

/* responsive small tweak */
@media (max-width:420px){
  #elysia_group_panel { width: 28px; }
  #elysia_group_wrapper .elysia-playlist { width: calc(240px - 28px - 6px) !important; }
}
</style>
</head>
<body>

<!-- === Elysia æ’­æ”¾å™¨ï¼ˆæ— æ•Œç‰ˆæœ¬ï¼‰ === -->
<!-- æ³¨æ„ï¼šæ’­æ”¾å™¨å…ƒç´ åŒæ—¶ä¹Ÿç”¨ä½œ 50px çƒä½“ï¼ˆcollapsed ç±»æ§åˆ¶ï¼‰ -->
<div class="elysia-player collapsed" id="elysiaPlayer" role="region" aria-label="Elysia Player" tabindex="0">
  <div class="elysia-controls" aria-hidden="true">
    <button id="playPauseBtn" aria-label="Play/Pause">â–¶</button>
    <button id="nextBtn" aria-label="Next">â­</button>
  </div>
  <span id="songTitle" class="clickable" role="button" tabindex="0">åŠ è½½ä¸­...</span>
</div>

<!-- æ’­æ”¾åˆ—è¡¨ï¼ˆå°†è¢«ç§»åŠ¨åˆ° group wrapper å†…ï¼‰ -->
<div class="elysia-playlist" id="playlist" aria-hidden="true"></div>

<!-- é¢„å…ˆåˆ›å»º group wrapper å ä½ï¼Œè„šæœ¬ä¼šæŠŠ playlist æ”¾å…¥å…¶ä¸­ -->
<div id="elysia_group_wrapper" aria-hidden="true" style="display:none;">
  <div id="elysia_group_panel" aria-hidden="true">
    <div class="group-item active" data-group="piano" title="piano">ğŸ¹</div>
    <div class="group-item" data-group="popular" title="popular">ğŸŒŸ</div>
  </div>
  <!-- playlist will be moved here by script -->
</div>

<script>
/* ===== ğŸµ æ­Œæ›²åˆ—è¡¨ï¼ˆåœ¨æ­¤ä¸ºæ¯é¦– song æ–°å¢ group å­—æ®µï¼Œéç ´åæ€§ï¼‰ =====
   æ³¨æ„ï¼šé»˜è®¤ group: "piano"ï¼Œåªæœ‰ "æ™´å¤©" æ ‡ä¸º "popular"ã€‚ä¿ç•™ä½ åŸæ¥çš„æ‰€æœ‰æ¡ç›®å¹¶å­—æ®µæ‰©å±•ã€‚ */
const songs = [
  { group: "piano", title: "My Soul, Your Beats!", src: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.mp3", cover: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.jpg" },
  { group: "piano", title: "My Most Precious Treasure", src: "assets/My Most Precious Treasure (From My Most Precious Treasure).mp3", cover: "assets/Key anime piano medley.jpg" },
  { group: "piano", title: "Shiteki de Souseiteki na Tori-tachi e no Shirabe", src: "assets/Shiteki de Souseiteki na Tori-tachi e no Shirabe (Yokunin no Tame no Piano Sanka).mp3", cover: "assets/Shiteki.jpg" },
  { group: "piano", title: "Last regrets, foretting me", src: "assets/Last regrets,foretting me.mp3", cover: "assets/Last regrets, foretting me.jpg" },
  { group: "piano", title: "Megumeru Gensoukyoku", src: "assets/Megumeru Gensoukyoku.mp3", cover: "assets/Megumeru Gensoukyoku.jpg" },
  { group: "piano", title: "Call of Silence", src: "assets/Call of Silence (From Attack on Titian) Piano Cover.mp3", cover: "assets/Call of Silence.jpg" },
  { group: "piano", title: "Only my Railgun OP1 fripSide", src: "assets/Only my Railgun - A Certain Scientific Railgun OP1 [Piano]  fripSide.mp3", cover: "assets/Level5.jpg" },
  { group: "piano", title: "Aoi Tori - The iDOLM", src: "assets/[Pianeet] Aoi Tori - The iDOLM@STER OST - Piano Tutorial  Synthesia.mp3", cover: "assets/Aoi Tori - The iDOLM.jpg" },
  { group: "piano", title: "é¬¼æ»…ä¹‹åˆƒ OPLiSA - ç´…è“®è¯", src: "assets/é¬¼æ»…ä¹‹åˆƒ OPLiSA - ç´…è“®è¯ Piano Cover.mp3", cover: "assets/Shinobu Kocho.jpg" },
  { group: "piano", title: "Flower Dance - DJ Okawari", src: "assets/Flower Dance - DJ Okawari (Piano Cover by Riyandi Kusuma).mp3", cover: "assets/Flower Dance - DJ Okawari.jpg" },
  { group: "piano", title: "theme of SSS -Piano Arrange ", src: "assets/theme of SSS -Piano Arrange Ver.-.mp3", cover: "assets/theme of SSS.jpg" },
  { group: "piano", title: "My Soul, Your Beats! Classic", src: "assets/My Soul, Your Beats! ~Classic~ Instrumental.mp3", cover: "assets/My Soul, Your Beats! ~Classic~ Instrumental.jpg" },
  { group: "piano", title: "Pachelbel's Canon", src: "assets/Bi.Bi PianoPachelbel's Canon ç»ˆäºå¼¹äº†è¿™é¦– ä¸–ç•Œä¸Šæœ€æ²»æ„ˆçš„é’¢ç´æ›²å¡å†œ.mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "Heroism endures in nothingness", src: "assets/è‹±é›„ä¸»ä¹‰-åœ¨è™šæ— ä¸­æ°¸å­˜.mp3", cover: "assets/heroism endures in nothingness.jpg" },
  { group: "piano", title: "è¯€åˆ«ä¹¦", src: "assets/é’¢ç´æ¼”å¥è¯€åˆ«ä¹¦çº¯éŸ³ä¹ç²¾ç¼–å®Œæ•´ç‰ˆ.mp3", cover: "assets/Elysia11.jpg" },
  { group: "piano", title: "Key anime piano medley", src: "assets/Air (TV), Kanon (2006), Clannad After Story - Key anime piano medley.mp3", cover: "assets/Key anime piano medley.jpg" },
  { group: "piano", title: "Crying for Rain", src: "assets/Crying for Rain (Kawaki wo Ameku) - Domestic na Kanojo OP [Piano]  Minami.mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "GIRLS BAND CRY", src: "assets/GIRLS BAND CRY OP - Wrong World - Piano Cover  TOGENASHI TOGEARI.mp3", cover: "assets/GIRLS BAND CRY.jpg" },
  { group: "piano", title: "Hikari no Senritsu", src: "assets/Hikari no Senritsu - Sora no Woto OP Arr. Animenz (2024 Fan Remaster Visualized).mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "LEVEL5 -judgelight", src: "assets/LEVEL5 -judgelight- A Certain Scientific Railgun OP2 [Piano].mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "Majo no Tabitabi", src: "assets/Majo no Tabitabi OPLiterature Piano Cover.mp3", cover: "assets/Majo no Tabitabi.jpg" },
  { group: "piano", title: "My Dearest ", src: "assets/My Dearest - Guilty Crown OP [10 Year Anniversary Edition] [Piano].mp3", cover: "assets/Mydearest.jpg" },
  { group: "piano", title: "Ninelie Kabaneri", src: "assets/Ninelie - Kabaneri of the Iron Fortress ED [Piano].mp3", cover: "assets/ninelie.jpg" },
  { group: "piano", title: "One Last Kiss", src: "assets/One Last Kiss - Evangelion_ 3.0  1.0 Theme Song [Piano]  Hikaru Utada.mp3", cover: "assets/one last kiss.jpg" },
  { group: "piano", title: "secret base", src: "assets/secret base - Kimi ga Kureta Mono - AnoHana ED [Piano].mp3", cover: "assets/secret base.jpg" },
  { group: "piano", title: "Blue Bird 2022 ver.", src: "assets/Blue Bird (2022 ver.) - Naruto Shippuuden OP3 [Piano]  Ikimono-gakari.mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "AKIBA POP the Future - Pianeet", src: "assets/AKIBA POP the Future - Pianeet [Piano Transcription].mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "SWORD ART ONLINE", src: "assets/SWORD ART ONLINE PIANO MEDLEY!!! (30,000 Subscribers Special).mp3", cover: "assets/banner1.jpg" },
  { group: "piano", title: "ç»™æˆ‘ä¸€é¦–æ­Œçš„æ—¶é—´", src: "assets/ç»™æˆ‘ä¸€é¦–æ­Œçš„æ—¶é—´ piano ver-.mp3", cover: "assets/banner1.jpg" },
  { group: "popular", title: "æ™´å¤©", src: "assets/å‘¨æ°ä¼¦æ™´å¤© é’¢ç´ç‹¬å¥ Jay ChouBi.Bi Piano.mp3", cover: "assets/banner1.jpg" }
];

/* ===== state ===== */
let currentSong = 0;
let audio = new Audio(songs[currentSong].src); // ä¸» audio
audio.preload = "auto";

/* ===== é¢„åŠ è½½ï¼ˆADDEDï¼‰ï¼šåˆ›å»ºä¸€ç»„ç”¨äºé¢„åŠ è½½ metadata çš„ Audio å¯¹è±¡ï¼ˆä¸ä¼šè‡ªåŠ¨æ’­æ”¾ï¼‰ ===== */
const preloadAudios = [];
(function preloadAll() {
  try {
    for (let i = 0; i < songs.length; i++) {
      const a = new Audio();
      a.preload = 'metadata'; // é¢„åŠ è½½å…ƒæ•°æ®ï¼ŒèŠ‚çœå¸¦å®½ä½†å¯åŠ è½½æ—¶é•¿/å°é¢ä¿¡æ¯
      a.src = songs[i].src;
      preloadAudios.push(a);
    }
    // æ ‡æ³¨ï¼šå¦‚æœä½ éœ€è¦æ›´æ¿€è¿›çš„ç¼“å­˜ï¼Œè¯·æŠŠ preload æ”¹ä¸º 'auto'ã€‚
  } catch (e) {
    console.warn('é¢„åŠ è½½å¤±è´¥', e);
  }
})();

/* ===== åŸå§‹ DOM å…ƒç´ å¼•ç”¨ï¼ˆä¿ç•™ä½ åŸæ¥çš„å˜é‡åï¼‰ ===== */
const playPauseBtn = document.getElementById("playPauseBtn");
const nextBtn = document.getElementById("nextBtn");
const titleEl = document.getElementById("songTitle");
const player = document.querySelector(".elysia-player");
const origPlaylist = document.getElementById("playlist");

/* ======== æ’­æ”¾åˆ—è¡¨æ¸²æŸ“ï¼ˆæŒ‰ group è¿‡æ»¤ï¼Œä¿ç•™åŸæ€è·¯ä½†æ”¯æŒåˆ†ç»„ï¼‰ ======== */
/* è¯´æ˜ï¼šrenderPlaylist è¢«æ›¿æ¢ä¸ºæŒ‰ window.currentGroup è¿‡æ»¤çš„ç‰ˆæœ¬ï¼ˆéç ´åæ€§ï¼‰ */
window.currentGroup = window.currentGroup || 'piano'; // å…¨å±€é»˜è®¤
function renderPlaylist() {
  const list = songs.map((s,i)=>({ ...s, _idx:i }))
                    .filter(x => (x.group || 'piano') === window.currentGroup);
  if (!list.length) {
    origPlaylist.innerHTML = '<div style="color:rgba(120,90,180,0.45);padding:8px;text-align:center;">No songs</div>';
    return;
  }
  origPlaylist.innerHTML = list.map(item => {
    const active = (item._idx === currentSong) ? 'active' : '';
    return `<div class="playlist-item ${active}" data-index="${item._idx}">${item.title}</div>`;
  }).join('');
}

/* ======== æ›´æ–°æ’­æ”¾æ­Œæ›² ======== */
function updateSong() {
  const song = songs[currentSong];
  if (!song) return;
  // åˆ‡æ¢ä¸» audio src ä¿ç•™ä¹‹å‰é€»è¾‘
  audio.src = song.src;
  titleEl.textContent = song.title;
  // å°è¯•æ’­æ”¾ï¼ˆè‹¥æµè§ˆå™¨ç­–ç•¥é˜»æ­¢ï¼Œcatch æ‰ï¼‰
  audio.play().catch(()=>{});
  playPauseBtn.textContent = "â¸";
  // é‡æ–°æ¸²æŸ“æ’­æ”¾åˆ—è¡¨ï¼ˆä»¥åæ˜  active çŠ¶æ€ï¼‰
  renderPlaylist();
  updateMediaSession(song);
}

/* ======== æ§åˆ¶æŒ‰é’® ======== */
playPauseBtn.addEventListener("click", () => {
  if (audio.paused || !audio.src) {
    audio.play().catch(()=>{});
    playPauseBtn.textContent = "â¸";
  } else {
    audio.pause();
    playPauseBtn.textContent = "â–¶";
  }
});

nextBtn.addEventListener("click", () => {
  currentSong = (currentSong + 1) % songs.length;
  updateSong();
});

audio.addEventListener("ended", () => nextBtn.click());
audio.addEventListener("play", () => player.classList.add("playing"));
audio.addEventListener("pause", () => player.classList.remove("playing"));

/* ======== ğŸ§ Media Session APIï¼ˆçµåŠ¨å²› + é”å±å°é¢ï¼‰ ======== */
function updateMediaSession(song) {
  if (!("mediaSession" in navigator)) return;
  try {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: song.title,
      artist: "Elysia Player",
      album: song.group || "Piano Collection",
      artwork: [
        { src: song.cover || 'assets/banner1.jpg', sizes: "96x96", type: "image/jpeg" },
        { src: song.cover || 'assets/banner1.jpg', sizes: "128x128", type: "image/jpeg" },
        { src: song.cover || 'assets/banner1.jpg', sizes: "192x192", type: "image/jpeg" },
        { src: song.cover || 'assets/banner1.jpg', sizes: "256x256", type: "image/jpeg" },
        { src: song.cover || 'assets/banner1.jpg', sizes: "512x512", type: "image/jpeg" }
      ]
    });
    navigator.mediaSession.playbackState = audio.paused ? "paused" : "playing";
    // æ·»åŠ  next/play/pause handler
    navigator.mediaSession.setActionHandler('nexttrack', () => { nextBtn.click(); });
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
  } catch(e) { console.warn("MediaSession update failed:", e); }
}

/* ======== ç‚¹å‡»æ’­æ”¾åˆ—è¡¨æ¡ç›® ======== */
origPlaylist.addEventListener("click", e => {
  const item = e.target.closest(".playlist-item");
  if (item) {
    const idx = parseInt(item.dataset.index, 10);
    if (!isNaN(idx)) {
      currentSong = idx;
      updateSong();
    }
  }
});

/* ======== æ‰“å¼€/å…³é—­æ’­æ”¾åˆ—è¡¨ï¼ˆåŸæœ‰å‡½æ•°ä¿ç•™ï¼Œä¸”ä¸ group wrapper åŒæ­¥ï¼‰ ======== */
function openPlaylist() {
  // åŸå…ˆè¡Œä¸ºï¼šä¸º #playlist å¢åŠ  show ç±»ï¼ˆåŠ¨ç”»ï¼‰
  origPlaylist.classList.remove("hide");
  origPlaylist.classList.add("show");
  origPlaylist.setAttribute('aria-hidden', 'false');
  // åŒæ­¥ group wrapper å¯è§æ€§
  const wrapper = document.getElementById('elysia_group_wrapper');
  if (wrapper) {
    wrapper.style.display = ''; // ensure visible in DOM
    wrapper.classList.add('show');
    wrapper.setAttribute('aria-hidden', 'false');
  }
}
function closePlaylist() {
  origPlaylist.classList.remove("show");
  origPlaylist.classList.add("hide");
  origPlaylist.setAttribute('aria-hidden', 'true');
  const wrapper = document.getElementById('elysia_group_wrapper');
  if (wrapper) {
    wrapper.classList.remove('show');
    wrapper.setAttribute('aria-hidden', 'true');
  }
}

/* ç‚¹å‡»æ­Œæ›²åï¼ˆæ ‡é¢˜ï¼‰åˆ‡æ¢åˆ—è¡¨æ˜¾ç¤ºï¼ˆä¿ç•™åŸå…ˆäº¤äº’ï¼‰ */
titleEl.addEventListener("click", e => {
  e.stopPropagation();
  if (origPlaylist.classList.contains("show")) closePlaylist();
  else openPlaylist();
});
document.addEventListener("click", e => {
  const wrapper = document.getElementById('elysia_group_wrapper');
  const gp = document.getElementById('elysia_group_panel');
  if (wrapper && (wrapper.contains(e.target) || (gp && gp.contains(e.target)))) return;
  if (!origPlaylist.contains(e.target) && e.target !== titleEl) {
    if (origPlaylist.classList.contains("show")) closePlaylist();
  }
});

/* ======== è‡ªåŠ¨éšè—æ’­æ”¾å™¨ï¼ˆ20sï¼Œæ— æ“ä½œéšè—ï¼‰ ======== */
let inactivityTimer;
function resetTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(()=> {
    // hide player (æ·¡å‡º)
    player.style.opacity = '0';
    player.style.pointerEvents = 'none';
  }, 20000); // 20s
}
['scroll','mousemove','mousedown','touchstart','keydown','pointermove'].forEach(evt => window.addEventListener(evt, ()=> {
  // å¦‚æœå·²éšè—ï¼Œæ¢å¤
  if (player.style.opacity === '0') {
    player.style.opacity = '1';
    player.style.pointerEvents = 'auto';
  }
  resetTimer();
}));

resetTimer();

/* ======== ADDED: å°†åŸå§‹ playlist ç§»åŠ¨åˆ° group wrapperï¼Œå¹¶å¯ç”¨åˆ†ç»„åˆ‡æ¢é€»è¾‘ï¼ˆéç ´åæ€§è¿½åŠ ï¼‰ ======== */
(function setupGroupWrapper() {
  const orig = document.getElementById('playlist');
  const gw = document.getElementById('elysia_group_wrapper');
  const gp = document.getElementById('elysia_group_panel');
  if (!orig || !gw || !gp) return;

  // å¦‚æœ wrapper è¿˜æ²¡æ’å…¥ DOMï¼ˆå ä½å·²åœ¨ä¸Šæ–¹åˆ›å»ºï¼‰ï¼ŒæŠŠ playlist æ”¾å…¥ wrapper
  if (!gw.contains(orig)) {
    gw.style.display = ''; // è§£é™¤ display:none
    orig.parentNode.insertBefore(gw, orig);
    gw.appendChild(gp);
    gw.appendChild(orig);
  }

  // group ç‚¹å‡»
  gp.addEventListener('click', e => {
    const item = e.target.closest('.group-item');
    if (!item) return;
    const group = item.dataset.group;
    // åˆ‡æ¢ global currentGroup
    window.currentGroup = group;
    // æ›´æ–° active æ ·å¼
    gp.querySelectorAll('.group-item').forEach(x=>x.classList.remove('active'));
    item.classList.add('active');
    // render filtered playlist
    renderPlaylist();
    // å¦‚æœå½“å‰ currentSong ä¸å±äºè¯¥ groupï¼Œé€‰ç»„å†…ç¬¬ä¸€ä¸ªå¹¶æ’­æ”¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const list = songs.map((s,i)=>({...s, _idx:i})).filter(x => (x.group||'piano') === window.currentGroup);
    if (list.length === 0) {
      // no songs in group -> åœæ­¢æ’­æ”¾ä½†ä¸æ”¶èµ·æ’­æ”¾å™¨
      try { audio.pause(); } catch(e) {}
      playPauseBtn.textContent = 'â–¶';
      orig.innerHTML = '<div style="color:rgba(120,90,180,0.45);padding:8px;text-align:center;">No songs</div>';
      return;
    }
    const isCurInGroup = list.some(it => it._idx === currentSong);
    if (!isCurInGroup) {
      currentSong = list[0]._idx;
      updateSong();
    } else {
      // ä¿ç•™å½“å‰æ’­æ”¾ï¼Œæ›´æ–° UI
      renderPlaylist();
      updateMediaSession(songs[currentSong]);
    }
    // ä¿è¯ wrapper / playlist å±•å¼€ï¼ˆç”¨æˆ·ç‚¹å›¾æ ‡ååº”è¯¥èƒ½çœ‹åˆ°ï¼‰
    gw.classList.add('show');
    orig.classList.add('show');
  });

  // å½“åŸå§‹ playlist ç±»å˜åŒ–æ—¶ï¼ŒåŒæ­¥ wrapper çš„ show/hideï¼ˆMutationObserverï¼‰
  const mo = new MutationObserver(muts => {
    muts.forEach(m => {
      if (m.type === 'attributes' && m.attributeName === 'class') {
        const cls = orig.classList;
        if (cls.contains('show')) gw.classList.add('show');
        else gw.classList.remove('show');
      }
    });
  });
  mo.observe(orig, { attributes: true });

  // override openPlaylist / closePlaylist ä»¥ç¡®ä¿ wrapper ä¹Ÿè·Ÿç€ï¼ˆå·²ç»åœ¨ä¸Šé¢å®šä¹‰ï¼‰
  // initial render
  renderPlaylist();
})();

/* ======== çƒä½“ â†’ æ’­æ”¾å™¨ æ¶²æ€å˜å½¢ + å¯æ‹–åŠ¨é€»è¾‘ï¼ˆADDEDï¼‰ ======== */
(function floatingDraggable() {
  const el = document.getElementById('elysiaPlayer');
  let collapsed = true; // åˆå§‹çŠ¶æ€æ˜¯çƒä½“ï¼ˆcollapsedï¼‰
  let dragging = false;
  let dragStart = {x:0,y:0};
  let elStart = {left: window.innerWidth/2, bottom: 20}; // ä¿å­˜æœ€åä½ç½®
  // restore starting position to center-bottom
  function setPositionFromState() {
    // when collapsed we honor stored elStart
    el.style.left = (elStart.left) + 'px';
    el.style.bottom = (elStart.bottom) + 'px';
    // transform none because we set absolute coords
    el.style.transform = 'translateX(0)';
  }
  // initialize collapsed position center-bottom
  elStart.left = (window.innerWidth - 50) / 2; // left in px (we use left coordinate)
  elStart.bottom = 20;
  // Put element into absolute coordinate mode while collapsed
  el.style.left = elStart.left + 'px';
  el.style.bottom = elStart.bottom + 'px';
  el.style.transform = 'translateX(0)';

  // Helper to collapse (morph back to ball)
  function collapseToBall() {
    collapsed = true;
    el.classList.add('collapsed');
    // restore last position (left/bottom)
    el.style.transition = 'width .45s, height .45s, border-radius .45s, padding .45s, left .45s, bottom .45s';
    setTimeout(()=> {
      // keep as is; nothing else
    }, 460);
    // hide playlist if open
    closePlaylist();
  }

  // Helper to expand (morph to full player at bottom center)
  function expandToPlayer() {
    collapsed = false;
    // center bottom position
    const targetLeft = (window.innerWidth - el.getBoundingClientRect().width) / 2;
    // We animate by moving to center bottom and removing collapsed class
    // First lock current coordinates then set left to 50% center after small delay
    el.classList.remove('collapsed');
    // Put it to centered positioned mode
    el.style.left = '50%';
    el.style.bottom = '20px';
    el.style.transform = 'translateX(-50%)';
    // show playlist wrapper
    const gw = document.getElementById('elysia_group_wrapper');
    if (gw) {
      gw.style.display = '';
      gw.classList.add('show');
      gw.setAttribute('aria-hidden','false');
      // ensure playlist content updated
      renderPlaylist();
      origPlaylist.classList.add('show');
    } else {
      // fallback: just show playlist
      origPlaylist.classList.add('show');
    }
    // ensure visible
    el.style.opacity = '1';
    el.style.pointerEvents = 'auto';
  }

  // Tap/click vs drag detection
  let pressTimer = null;
  let moved = false;

  // Use Pointer events for desktop/mobile unified handling
  el.addEventListener('pointerdown', (ev) => {
    // Only start drag when collapsed (when expanded we want click to expand/controls)
    el.setPointerCapture(ev.pointerId);
    dragStart = { x: ev.clientX, y: ev.clientY };
    const rect = el.getBoundingClientRect();
    // compute left,bottom numeric values
    const leftPx = rect.left;
    const bottomPx = window.innerHeight - rect.bottom;
    elStart.left = leftPx;
    elStart.bottom = bottomPx;
    moved = false;
    // start timer to allow distinguishing click vs drag
    pressTimer = setTimeout(()=> { pressTimer = null; }, 200);
  });

  el.addEventListener('pointermove', (ev) => {
    if (pressTimer !== null) {
      // if moved beyond threshold before timer, treat as dragging
      const dx = Math.abs(ev.clientX - dragStart.x);
      const dy = Math.abs(ev.clientY - dragStart.y);
      if (dx > 6 || dy > 6) {
        clearTimeout(pressTimer);
        pressTimer = null;
        dragging = true;
        el.classList.add('dragging');
      }
    }
    if (dragging) {
      moved = true;
      // compute new left/bottom
      let newLeft = elStart.left + (ev.clientX - dragStart.x);
      let newBottom = elStart.bottom - (ev.clientY - dragStart.y);
      // clamp within viewport
      const pad = 8;
      newLeft = Math.max(pad, Math.min(window.innerWidth - el.offsetWidth - pad, newLeft));
      newBottom = Math.max(8, Math.min(window.innerHeight - el.offsetHeight - pad, newBottom));
      el.style.left = newLeft + 'px';
      el.style.bottom = newBottom + 'px';
      el.style.transform = 'translateX(0)';
    }
  });

  el.addEventListener('pointerup', (ev) => {
    el.releasePointerCapture(ev.pointerId);
    if (pressTimer !== null) {
      // short press -> toggle expand/collapse
      clearTimeout(pressTimer);
      pressTimer = null;
      // If collapsed -> expand; if expanded -> collapse
      if (collapsed) {
        expandToPlayer();
      } else {
        // collapse: store current left/bottom
        const rect = el.getBoundingClientRect();
        elStart.left = rect.left;
        elStart.bottom = window.innerHeight - rect.bottom;
        collapseToBall();
        // position the ball back to stored coordinates
        setPositionFromState();
      }
    } else if (dragging) {
      // dragging ended, save position and stop dragging class
      dragging = false;
      el.classList.remove('dragging');
      // store final position
      const rect = el.getBoundingClientRect();
      elStart.left = rect.left;
      elStart.bottom = window.innerHeight - rect.bottom;
      // keep collapsed if we were collapsed
      if (collapsed) {
        el.classList.add('collapsed');
        setPositionFromState();
      }
    } else {
      // nothing: no-op
    }
    moved = false;
  });

  // double click / keyboard toggle as accessibility
  el.addEventListener('dblclick', () => {
    if (collapsed) expandToPlayer();
    else collapseToBall();
  });
  el.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      if (collapsed) expandToPlayer();
      else collapseToBall();
    }
  });

  // When the player expands or collapses via other triggers (openPlaylist), ensure classes sync
  // If playlist opened externally, ensure the player expands
  const observer = new MutationObserver(muts => {
    muts.forEach(m => {
      if (m.type === 'attributes' && m.attributeName === 'class') {
        if (origPlaylist.classList.contains('show')) {
          // expand to show playlist
          expandToPlayer();
        }
      }
    });
  });
  observer.observe(origPlaylist, { attributes: true });

  // initial state: collapsed and positioned center-bottom
  el.classList.add('collapsed');
  setPositionFromState();

  // Expose collapse/expand for other code (if necessary)
  window._elysia_controls = {
    expand: expandToPlayer,
    collapse: collapseToBall
  };
})();

/* ======== å…¼å®¹æ€§ / å¯åŠ¨æ—¶æ¸²æŸ“ ======== */
renderPlaylist();
updateSong();

/* ======== é¢å¤–è¯´æ˜ï¼ˆä¿ç•™ä¸­æ–‡æ³¨é‡Šä¾¿äºç»´æŠ¤ï¼‰ ========
 - åˆ†ç»„æ•°æ®é€šè¿‡ songs[].group ç®¡ç†ï¼›é»˜è®¤ pianoï¼›
 - å·¦ä¾§åˆ†ç»„å®½åº¦å›ºå®š 30pxï¼Œæ’­æ”¾åˆ—è¡¨å®½åº¦æ ¹æ® (260 - 30 - 6) è®¡ç®—ä¿æŒæ•´ä½“å®½åº¦ä¸€è‡´ï¼›
 - å½“åˆ‡æ¢åˆ†ç»„æ—¶ï¼Œå¦‚æœè¯¥åˆ†ç»„æ²¡æœ‰æ­Œæ›²ï¼ŒUI ä¼šæ˜¾ç¤º "No songs" å¹¶åœæ­¢æ’­æ”¾ï¼ˆä¸ä¼šè‡ªåŠ¨æ”¶å›ï¼‰ï¼›
 - é¢„åŠ è½½é€»è¾‘åªåš metadata é¢„çƒ­ä»¥å…¼é¡¾æ€§èƒ½ï¼Œå¯æŒ‰éœ€è°ƒæ•´ä¸º 'auto'ã€‚
 - å¦‚æœéœ€è¦å°†æ›´å¤šæ­Œæ›²æ ‡ä¸º popularï¼Œè¯·åœ¨ songs ä¸­æŠŠå¯¹åº”æ¡ç›®çš„ group æ”¹ä¸º "popular"ã€‚
======================================================== */

</script>
</body>
</html>