<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elysia Player</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="player" class="glass">
    <div id="songTitle">AKIBA POP the Future - Pianeet</div>
    <audio id="audio" controls></audio>

    <div id="controls">
      <button id="prevBtn">â®ï¸</button>
      <button id="playPauseBtn">â–¶ï¸</button>
      <button id="nextBtn">â­ï¸</button>
    </div>

    <div id="playlist">
      <div class="song" data-src="assets/AKIBA POP the Future - Pianeet [Piano Transcription].mp3">
        AKIBA POP the Future - Pianeet
      </div>
      <div class="song" data-src="assets/[Pianeet] Aoi Tori - The iDOLM@STER OST - Piano Tutorial  Synthesia.mp3">
        Aoi Tori - The iDOLM
      </div>
    </div>
  </div>

  <script>
    const songs = [
      { title: "AKIBA POP the Future - Pianeet", src: "assets/AKIBA POP the Future - Pianeet [Piano Transcription].mp3" },
      { title: "Aoi Tori - The iDOLM", src: "assets/[Pianeet] Aoi Tori - The iDOLM@STER OST - Piano Tutorial  Synthesia.mp3" }
    ];

    const audio = document.getElementById("audio");
    const songTitle = document.getElementById("songTitle");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const playlistItems = document.querySelectorAll(".song");

    let currentSong = 0;

    function updateSong() {
      const song = songs[currentSong];
      audio.src = song.src;
      songTitle.textContent = song.title;
      updateMediaSession(); // ä¿ç•™åŸé€»è¾‘
      audio.play();
    }

    playPauseBtn.addEventListener("click", () => {
      if (audio.paused) {
        audio.play();
        playPauseBtn.textContent = "â¸ï¸";
      } else {
        audio.pause();
        playPauseBtn.textContent = "â–¶ï¸";
      }
    });

    nextBtn.addEventListener("click", () => {
      currentSong = (currentSong + 1) % songs.length;
      updateSong();
    });

    prevBtn.addEventListener("click", () => {
      currentSong = (currentSong - 1 + songs.length) % songs.length;
      updateSong();
    });

    playlistItems.forEach((item, index) => {
      item.addEventListener("click", () => {
        currentSong = index;
        updateSong();
      });
    });

    audio.addEventListener("ended", () => {
      currentSong = (currentSong + 1) % songs.length;
      updateSong();
    });

    // === ğŸ§ Media Session API ===
    function updateMediaSession() {
      if (!("mediaSession" in navigator)) return;

      // å¼ºåˆ¶æ¸…ç†æ—§å°é¢ï¼Œé¿å… iOS ç¼“å­˜
      navigator.mediaSession.metadata = null;

      navigator.mediaSession.metadata = new MediaMetadata({
        title: songs[currentSong].title,
        artist: "Elysia Player",
        album: "Piano Collection",
        artwork: [
          { src: location.origin + "/assets/banner.jpg", sizes: "96x96", type: "image/jpeg" },
          { src: location.origin + "/assets/banner.jpg", sizes: "128x128", type: "image/jpeg" },
          { src: location.origin + "/assets/banner.jpg", sizes: "192x192", type: "image/jpeg" },
          { src: location.origin + "/assets/banner.jpg", sizes: "256x256", type: "image/jpeg" },
          { src: location.origin + "/assets/banner.jpg", sizes: "512x512", type: "image/jpeg" }
        ]
      });

      navigator.mediaSession.playbackState = audio.paused ? "paused" : "playing";

      try {
        navigator.mediaSession.setActionHandler("play", () => {
          audio.play();
          playPauseBtn.textContent = "â¸ï¸";
        });
      } catch (e) {}

      try {
        navigator.mediaSession.setActionHandler("pause", () => {
          audio.pause();
          playPauseBtn.textContent = "â–¶ï¸";
        });
      } catch (e) {}

      try {
        navigator.mediaSession.setActionHandler("previoustrack", () => {
          currentSong = (currentSong - 1 + songs.length) % songs.length;
          updateSong();
        });
      } catch (e) {}

      try {
        navigator.mediaSession.setActionHandler("nexttrack", () => {
          currentSong = (currentSong + 1) % songs.length;
          updateSong();
        });
      } catch (e) {}
    }

    // âœ… æ–°å¢ï¼šç¡®ä¿æ’­æ”¾å¼€å§‹åæ‰æ³¨å†Œ Media Sessionï¼ˆä¿®å¤ iOS ä¸è¯†åˆ«ï¼‰
    if ("mediaSession" in navigator) {
      audio.addEventListener("play", () => {
        setTimeout(() => {
          updateMediaSession();
          navigator.mediaSession.playbackState = "playing";
          console.log("âœ… MediaSession metadata å·²æ›´æ–°:", songs[currentSong].title);
        }, 500); // å»¶è¿Ÿè§¦å‘ï¼Œç¡®ä¿ Safari å·²æ³¨å†ŒéŸ³é¢‘æµ
      });

      audio.addEventListener("pause", () => {
        navigator.mediaSession.playbackState = "paused";
      });
    }

    // åˆå§‹åŒ–
    updateSong();
  </script>
</body>
</html>