<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Elysia Immersive</title>
  <style>
    :root {
      --text-main: rgba(255, 255, 255, 0.92);
      --text-sub: rgba(255, 255, 255, 0.6);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      background: #000;
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* === WebGL 背景容器 === */
    #glCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      /* 稍微调暗一点背景，保证文字清晰 */
      filter: brightness(0.75) contrast(1.1); 
    }

    /* === 顶部导航 === */
    .nav-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: max(20px, env(safe-area-inset-top)) 24px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    
    .capsule-btn {
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
    }

    /* === 主布局 === */
    .player-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      height: 100%;
      padding: 20px;
      justify-content: center;
    }

    @media (min-width: 768px) {
      .player-layout {
        flex-direction: row;
        gap: 80px;
        padding: 60px;
      }
      .art-section, .controls-section { flex: 1; }
      .controls-section { max-width: 450px; }
    }

    /* === 封面 === */
    .art-section {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin-bottom: 30px;
    }
    @media (min-width: 768px) { margin-bottom: 0; }

    .album-art-wrapper {
      width: 80vw;
      height: 80vw;
      max-width: 360px;
      max-height: 360px;
      border-radius: 12px;
      position: relative;
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    
    .album-art-wrapper img {
      width: 100%; height: 100%;
      object-fit: cover;
      border-radius: 12px;
      display: block;
      /* 细微的反射光泽 */
      mask-image: linear-gradient(to bottom, black 80%, rgba(0,0,0,0.8) 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 80%, rgba(0,0,0,0.8) 100%);
    }

    .is-playing .album-art-wrapper { transform: scale(1); box-shadow: 0 30px 80px rgba(0,0,0,0.5); }
    .is-paused .album-art-wrapper { transform: scale(0.82); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

    /* === 控制区 === */
    .controls-section { width: 100%; display: flex; flex-direction: column; justify-content: center; }

    .song-info { margin-bottom: 30px; text-align: center; }
    @media (min-width: 768px) { .song-info { text-align: left; } }

    .song-title { font-size: 26px; font-weight: 700; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .artist-name { font-size: 18px; color: var(--text-sub); }

    /* 进度条 */
    .progress-container { margin-bottom: 50px; width: 100%; cursor: pointer; }
    .slider-track {
      width: 100%; height: 5px; background: rgba(255,255,255,0.15); border-radius: 3px; position: relative;
    }
    .progress-fill {
      position: absolute; top: 0; left: 0; bottom: 0; width: 0%; background: #fff; border-radius: 3px; pointer-events: none;
      box-shadow: 0 0 12px rgba(255,255,255,0.4);
    }
    input[type=range] {
      -webkit-appearance: none; width: 100%; height: 20px; background: transparent; position: absolute; top: -7px; left: 0; margin: 0; z-index: 2; opacity: 0; cursor: pointer;
    }
    .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-top: 10px; font-weight: 600; font-variant-numeric: tabular-nums; }

    /* 按钮 */
    .controls-row { display: flex; align-items: center; justify-content: center; gap: 45px; }
    @media (min-width: 768px) { .controls-row { justify-content: flex-start; } }

    .ctrl-btn { background: none; border: none; cursor: pointer; color: #fff; display: flex; transition: transform 0.2s, opacity 0.2s; }
    .ctrl-btn:active { transform: scale(0.8); }
    .ctrl-icon { width: 36px; height: 36px; fill: currentColor; }
    
    .btn-play-pause {
      width: 76px; height: 76px; border-radius: 50%; background: #fff; color: #000;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .btn-play-pause .ctrl-icon { width: 34px; height: 34px; margin-left: 2px; }
    .btn-play-pause.playing .ctrl-icon { margin-left: 0; }
  </style>
</head>
<body class="is-paused">

  <canvas id="glCanvas"></canvas>

  <nav class="nav-bar">
    <button class="capsule-btn" onclick="goBack()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      Back
    </button>
  </nav>

  <main class="player-layout">
    <section class="art-section">
      <div class="album-art-wrapper">
        <img id="coverImg" src="" alt="Album Art">
      </div>
    </section>

    <section class="controls-section">
      <div class="song-info">
        <div class="song-title" id="songTitle">Loading...</div>
        <div class="artist-name">Elysia Collection</div>
      </div>

      <div class="progress-container">
        <div class="slider-track">
          <div class="progress-fill" id="progressFill"></div>
          <input type="range" id="progressBar" min="0" value="0" step="0.1">
        </div>
        <div class="time-labels">
          <span id="currTime">0:00</span>
          <span id="totalTime">-:--</span>
        </div>
      </div>

      <div class="controls-row">
        <button class="ctrl-btn" id="prevBtn"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="ctrl-btn btn-play-pause" id="playBtn">
          <svg class="ctrl-icon" id="iconPlay" style="display:block" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="ctrl-icon" id="iconPause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="ctrl-btn" id="nextBtn"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
      </div>
    </section>
  </main>

  <script id="vs" type="x-shader/x-vertex">
    attribute vec4 position;
    void main() {
      gl_Position = position;
    }
  </script>

  <script id="fs" type="x-shader/x-fragment">
    precision highp float;
    uniform vec2 iResolution;
    uniform float iTime;
    
    // 简单的哈希函数
    float hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }

    // 噪声函数 (用于生成自然的流动感)
    float noise(vec2 x) {
        vec2 i = floor(x);
        vec2 f = fract(x);
        float a = hash(i);
        float b = hash(i + vec2(1.0, 0.0));
        float c = hash(i + vec2(0.0, 1.0));
        float d = hash(i + vec2(1.0, 1.0));
        vec2 u = f * f * (3.0 - 2.0 * f);
        return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
    }

    // 分形布朗运动 (增加细节层次)
    float fbm(vec2 x) {
        float v = 0.0;
        float a = 0.5;
        vec2 shift = vec2(100);
        mat2 rot = mat2(cos(0.5), sin(0.5), -sin(0.5), cos(0.50));
        for (int i = 0; i < 5; ++i) {
            v += a * noise(x);
            x = rot * x * 2.0 + shift;
            a *= 0.5;
        }
        return v;
    }

    void main() {
        vec2 uv = gl_FragCoord.xy / iResolution.xy;
        
        // 调整宽高比
        uv.x *= iResolution.x / iResolution.y;

        float time = iTime * 0.15; // 控制流速

        vec2 q = vec2(0.);
        q.x = fbm(uv + 0.00 * time);
        q.y = fbm(uv + vec2(1.0));

        vec2 r = vec2(0.);
        r.x = fbm(uv + 1.0 * q + vec2(1.7, 9.2) + 0.15 * time);
        r.y = fbm(uv + 1.0 * q + vec2(8.3, 2.8) + 0.126 * time);

        float f = fbm(uv + r);

        // === 调色板 (Apple Music 风格核心) ===
        // 这里定义了颜色的混合方式
        vec3 color = mix(
            vec3(0.1, 0.0, 0.3), // 深紫色基底
            vec3(0.3, 0.0, 0.4), // 深红紫色
            clamp((f * f) * 4.0, 0.0, 1.0)
        );

        color = mix(
            color,
            vec3(0.0, 0.3, 0.7), // 蓝色
            clamp(length(q), 0.0, 1.0)
        );

        color = mix(
            color,
            vec3(0.9, 0.1, 0.4), // 亮粉色/洋红 (点睛之笔)
            clamp(length(r.x), 0.0, 1.0)
        );

        // 加上一点光泽
        vec3 finalColor = (f * f * f + 0.6 * f * f + 0.5 * f) * color;
        
        // 添加细微的颗粒感 (Dithering) 以防止色带
        // float grain = hash(uv * iTime) * 0.03;
        
        gl_FragColor = vec4(finalColor * 1.3, 1.0);
    }
  </script>

  <script>
    /* ================= WebGL 初始化 ================= */
    const canvas = document.getElementById("glCanvas");
    const gl = canvas.getContext("webgl");

    if (!gl) {
      console.error("WebGL not supported");
    }

    // 编译 Shader 的辅助函数
    function createShader(gl, type, source) {
      const shader = gl.createShader(type);
      gl.shaderSource(shader, source);
      gl.compileShader(shader);
      if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
        console.error(gl.getShaderInfoLog(shader));
        gl.deleteShader(shader);
        return null;
      }
      return shader;
    }

    const vsSource = document.getElementById("vs").text;
    const fsSource = document.getElementById("fs").text;
    const vertexShader = createShader(gl, gl.VERTEX_SHADER, vsSource);
    const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fsSource);

    const program = gl.createProgram();
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    gl.linkProgram(program);

    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
      console.error(gl.getProgramInfoLog(program));
    }

    gl.useProgram(program);

    // 设置全屏矩形
    const positionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    const positions = [ -1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1 ];
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);

    const positionAttributeLocation = gl.getAttribLocation(program, "position");
    gl.enableVertexAttribArray(positionAttributeLocation);
    gl.vertexAttribPointer(positionAttributeLocation, 2, gl.FLOAT, false, 0, 0);

    // 获取 Uniform 位置
    const resolutionLocation = gl.getUniformLocation(program, "iResolution");
    const timeLocation = gl.getUniformLocation(program, "iTime");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      gl.viewport(0, 0, canvas.width, canvas.height);
      gl.uniform2f(resolutionLocation, canvas.width, canvas.height);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 渲染循环
    function render(time) {
      time *= 0.001; // 转换为秒
      gl.uniform1f(timeLocation, time);
      gl.drawArrays(gl.TRIANGLES, 0, 6);
      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);


    /* ================= 音乐播放器逻辑 (同之前) ================= */
    const songs = [
      // ⚠️⚠️⚠️ 请务必在此处粘贴你 elysiamusic.js 中完整的 songs 数组 ⚠️⚠️⚠️
      { title: "My Soul, Your Beats!", src: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.mp3", cover: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.jpg" },
      { title: "My Most Precious Treasure", src: "assets/My Most Precious Treasure (From My Most Precious Treasure).mp3", cover: "assets/Key anime piano medley.jpg" },
      { title: "Duvert 四季 Merry mixed", src: "assets/mix.mp3", cover: "assets/Elysia11.jpg" }
    ];

    const audio = new Audio();
    let currentIndex = 0;
    let isDragging = false;
    
    const els = {
      body: document.body,
      cover: document.getElementById('coverImg'),
      title: document.getElementById('songTitle'),
      playBtn: document.getElementById('playBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      progressFill: document.getElementById('progressFill'),
      progressBar: document.getElementById('progressBar'),
      currTime: document.getElementById('currTime'),
      totalTime: document.getElementById('totalTime'),
      iconPlay: document.getElementById('iconPlay'),
      iconPause: document.getElementById('iconPause')
    };

    function initPlayer() {
      const params = new URLSearchParams(window.location.search);
      const idx = params.get('index');
      const t = params.get('time');
      const st = params.get('status');

      if (idx !== null) currentIndex = parseInt(idx) % songs.length;
      loadSong(currentIndex);

      if (t) audio.currentTime = parseFloat(t);
      if (st === 'play') setTimeout(playMusic, 150);
    }

    function loadSong(i) {
      const s = songs[i];
      audio.src = s.src;
      els.title.innerText = s.title;
      els.cover.src = s.cover;
      // 设置 MediaSession
      if('mediaSession' in navigator){
         navigator.mediaSession.metadata = new MediaMetadata({
           title: s.title, artist: 'Elysia Collection', artwork: [{src: s.cover, sizes: '512x512', type: 'image/jpeg'}]
         });
         navigator.mediaSession.setActionHandler('play', playMusic);
         navigator.mediaSession.setActionHandler('pause', pauseMusic);
         navigator.mediaSession.setActionHandler('previoustrack', playPrev);
         navigator.mediaSession.setActionHandler('nexttrack', playNext);
      }
    }

    function playMusic() {
      audio.play().then(() => updateState(true)).catch(() => updateState(false));
    }
    function pauseMusic() {
      audio.pause();
      updateState(false);
    }
    function updateState(playing) {
      if (playing) {
        els.body.classList.add('is-playing'); els.body.classList.remove('is-paused');
        els.iconPlay.style.display='none'; els.iconPause.style.display='block';
        els.playBtn.classList.add('playing');
      } else {
        els.body.classList.remove('is-playing'); els.body.classList.add('is-paused');
        els.iconPlay.style.display='block'; els.iconPause.style.display='none';
        els.playBtn.classList.remove('playing');
      }
    }

    function playNext() { currentIndex = (currentIndex + 1) % songs.length; loadSong(currentIndex); playMusic(); }
    function playPrev() { currentIndex = (currentIndex - 1 + songs.length) % songs.length; loadSong(currentIndex); playMusic(); }

    els.playBtn.onclick = () => audio.paused ? playMusic() : pauseMusic();
    els.nextBtn.onclick = playNext;
    els.prevBtn.onclick = playPrev;

    audio.ontimeupdate = () => {
      if(!isDragging) {
        const d = audio.duration || 0;
        const p = (audio.currentTime / d) * 100;
        els.progressBar.value = p;
        els.progressFill.style.width = p + '%';
        els.currTime.innerText = formatTime(audio.currentTime);
        els.totalTime.innerText = formatTime(d);
      }
    };
    audio.onended = playNext;

    els.progressBar.oninput = (e) => { isDragging = true; els.progressFill.style.width = e.target.value + '%'; };
    els.progressBar.onchange = (e) => {
      isDragging = false;
      audio.currentTime = (e.target.value / 100) * (audio.duration || 0);
      if(audio.paused) playMusic();
    };

    function formatTime(s) {
      if(isNaN(s)) return "0:00";
      const m = Math.floor(s/60), sec = Math.floor(s%60);
      return `${m}:${sec<10?'0':''}${sec}`;
    }

    window.goBack = () => window.location.href = "index.html";
    initPlayer();
  </script>
</body>
</html>
