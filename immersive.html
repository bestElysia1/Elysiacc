<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Aura Style Player</title>
  <style>
    :root {
      --text-main: #ffffff;
      --text-sub: rgba(255, 255, 255, 0.7);
      --primary-color: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.12);
      --glass-border: rgba(255, 255, 255, 0.2);
      --bg-blur: 60px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
      background: #000;
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* === 沉浸式背景 === */
    #bgVideo {
      position: fixed;
      top: 50%; left: 50%;
      min-width: 100%; min-height: 100%;
      width: auto; height: auto;
      z-index: -2;
      object-fit: cover;
      /* 增加模糊度和压暗，突出前景 */
      filter: blur(var(--bg-blur)) brightness(0.6) saturate(1.2); 
      transform: translate(-50%, -50%) scale(1.2);
    }

    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.2); /* 轻微遮罩 */
      z-index: -1;
      pointer-events: none;
    }

    /* === 导航栏 === */
    .nav-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: max(24px, env(safe-area-inset-top)) 32px;
      z-index: 10;
      display: flex; align-items: center;
    }
    
    .icon-btn {
      background: transparent; border: none; color: var(--text-main); cursor: pointer; padding: 8px;
      display: flex; align-items: center; justify-content: center;
      transition: opacity 0.2s;
    }
    .icon-btn:active { opacity: 0.6; }
    .icon-btn svg { width: 28px; height: 28px; }

    /* === 主体布局 === */
    .player-layout {
      flex: 1; width: 100%; height: 100%;
      display: flex; flex-direction: column;
      padding: 24px;
      padding-top: calc(max(24px, env(safe-area-inset-top)) + 60px); /* 为导航栏留空 */
      padding-bottom: max(32px, env(safe-area-inset-bottom));
      justify-content: space-evenly; /* 内容垂直分布 */
    }

    /* 桌面端布局优化 (Aura风格核心) */
    @media (min-width: 900px) {
      .player-layout {
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 80px; /* 左右间距 */
        padding: 60px;
      }

      /* 左侧封面区 */
      .art-section {
        flex: 1;
        max-width: 500px;
        display: flex; justify-content: flex-end;
        margin-bottom: 0 !important;
      }
      .album-art-wrapper {
        width: 45vh !important; height: 45vh !important; /* 使用视口高度基准 */
        max-width: 500px !important; max-height: 500px !important;
      }

      /* 右侧控制区：玻璃卡片 */
      .controls-section {
        flex: 1;
        max-width: 500px;
        background: var(--glass-bg);
        backdrop-filter: blur(40px) saturate(1.5); -webkit-backdrop-filter: blur(40px) saturate(1.5);
        border-radius: 32px;
        border: 1px solid var(--glass-border);
        padding: 48px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        align-items: stretch !important; /* 拉伸宽度 */
      }
      .song-info { text-align: left !important; margin-bottom: 30px !important; }
      .song-title { font-size: 36px !important; }
      .artist-name { font-size: 20px !important; }
    }

    /* === 封面区域 === */
    .art-section { width: 100%; display: flex; justify-content: center; margin-bottom: 2vh; transition: all 0.3s ease;}
    .album-art-wrapper {
      width: min(80vw, 380px); height: min(80vw, 380px);
      border-radius: 20px; /* 更圆润 */
      position: relative;
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.6s ease; /* 更有弹性的动画 */
      box-shadow: 0 20px 60px -15px rgba(0,0,0,0.6);
      overflow: hidden;
    }
    .album-art-wrapper img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    /* 播放/暂停动画状态 */
    .is-paused .album-art-wrapper { transform: scale(0.9); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); opacity: 0.9; }

    /* === 控制区域 === */
    .controls-section { width: 100%; max-width: 420px; margin: 0 auto; display: flex; flex-direction: column; align-items: center;}
    
    /* 歌曲信息：更大、更清晰 */
    .song-info { text-align: center; margin-bottom: 20px; width: 100%; }
    .song-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: -0.5px;}
    .artist-name { font-size: 18px; color: var(--text-sub); font-weight: 500; }

    /* === 频谱可视化 (更大、更显眼) === */
    #visualizer {
      width: 100%;
      height: 80px; /* 增加高度 */
      display: block;
      margin-bottom: 20px;
      opacity: 0.8;
      /* 尝试添加混合模式让它看起来更融合 (可选) */
      /* mix-blend-mode: overlay; */ 
    }

    /* === 优化的进度条 === */
    .progress-container { margin-bottom: 32px; width: 100%; position: relative; padding-top: 10px; }
    .slider-track { 
      width: 100%; height: 6px; /* 变粗 */
      background: rgba(255,255,255,0.15); 
      border-radius: 99px; position: relative; overflow: hidden;
    }
    .progress-fill { 
      position: absolute; left:0; top:0; bottom:0; width:0%; 
      background: var(--primary-color); 
      border-radius: 99px; 
    }
    /* 自定义 Range Input 样式 (增加 Thumb) */
    input[type=range] { 
      -webkit-appearance:none; position:absolute; width:100%; height:26px; top:-10px; left:0; background:transparent; z-index:3; cursor: pointer;
    }
    /* Webkit Thumb */
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      margin-top: -5px; /* 调整对齐 */
      transition: transform 0.1s;
    }
    input[type=range]:active::-webkit-slider-thumb { transform: scale(1.3); }

    .time-labels { display:flex; justify-content:space-between; font-size: 13px; color:var(--text-sub); margin-top: 12px; font-weight: 600; letter-spacing: 0.5px; }

    /* === 控制按钮 (使用填充风格图标) === */
    .controls-row { display:flex; align-items:center; justify-content:center; gap: 32px; width: 100%; }
    .ctrl-btn { background:none; border:none; color: var(--text-main); cursor:pointer; display:flex; transition:transform 0.2s, color 0.2s; padding: 8px;}
    .ctrl-btn:active { transform:scale(0.88); color: var(--text-sub); }
    .ctrl-icon { width: 42px; height: 42px; fill:currentColor; } /* 增大侧边图标 */
    
    /* 主播放按钮 */
    .btn-play-pause { 
      width: 88px; height: 88px; /* 更大 */
      background: var(--primary-color); color:#000; 
      border-radius: 50%; align-items:center; justify-content:center; 
      box-shadow: 0 12px 32px rgba(255,255,255,0.25); 
    }
    .btn-play-pause:active { transform: scale(0.92); }
    .btn-play-pause .ctrl-icon { width: 36px; height: 36px; }
  </style>
</head>
<body class="is-paused">

  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="assets/bg.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <nav class="nav-bar">
    <button class="icon-btn" onclick="goBack()" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
  </nav>

  <main class="player-layout">
    <section class="art-section">
      <div class="album-art-wrapper">
        <img id="coverImg" src="" alt="Album Art">
      </div>
    </section>

    <section class="controls-section">
      <div class="song-info">
        <div class="song-title" id="songTitle">Elysia</div>
        <div class="artist-name">Elysia Collection</div>
      </div>

      <canvas id="visualizer"></canvas>

      <div class="progress-container">
        <div class="slider-track">
          <div class="progress-fill" id="progressFill"></div>
          <input type="range" id="progressBar" min="0" value="0" step="any">
        </div>
        <div class="time-labels">
          <span id="currTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
      </div>

      <div class="controls-row">
        <button class="ctrl-btn" id="prevBtn" aria-label="Previous">
          <svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        
        <button class="ctrl-btn btn-play-pause" id="playBtn" aria-label="Play/Pause">
          <svg class="ctrl-icon" id="iconPlay" style="display:block" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="ctrl-icon" id="iconPause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        
        <button class="ctrl-btn" id="nextBtn" aria-label="Next">
          <svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
      </div>
    </section>
  </main>

  <script>
    // ================== 音乐数据 ==================
    const songs = [
      { title: "My Soul, Your Beats!", src: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.mp3", cover: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.jpg" },
      { title: "My Most Precious Treasure", src: "assets/My Most Precious Treasure (From My Most Precious Treasure).mp3", cover: "assets/Key anime piano medley.jpg" },
      { title: "Duvert 四季 Merry mixed", src: "assets/mix.mp3", cover: "assets/Elysia11.jpg" }
    ];

    const audio = new Audio();
    audio.crossOrigin = "anonymous"; // 重要：允许跨域分析音频

    let currentIndex = 0;
    let isDragging = false;
    
    // === 频谱相关变量 ===
    let audioContext, analyser, source;
    let canvas, ctx;
    let isVisualizerInited = false;
    let animationId;

    const els = {
      body: document.body, cover: document.getElementById('coverImg'),
      title: document.getElementById('songTitle'), artist: document.querySelector('.artist-name'),
      playBtn: document.getElementById('playBtn'), prevBtn: document.getElementById('prevBtn'), nextBtn: document.getElementById('nextBtn'),
      pFill: document.getElementById('progressFill'), pBar: document.getElementById('progressBar'),
      currT: document.getElementById('currTime'), totalT: document.getElementById('totalTime'),
      iconPlay: document.getElementById('iconPlay'), iconPause: document.getElementById('iconPause')
    };

    // ================== 优化后的频谱可视化逻辑 ==================
    const initVisualizer = () => {
      if (isVisualizerInited) return;

      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        analyser = audioContext.createAnalyser();
        // fftSize 决定条的数量。128或256比较适合这种现代风格
        analyser.fftSize = 256; 
        // smoothingTimeConstant 让频谱跳动更平滑 (0-1, 越大越平滑)
        analyser.smoothingTimeConstant = 0.75;

        source = audioContext.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioContext.destination);

        canvas = document.getElementById('visualizer');
        ctx = canvas.getContext('2d');
        resizeCanvas();

        isVisualizerInited = true;
        renderFrame();
      } catch (e) {
        console.warn("Visualizer init failed:", e);
      }
    };

    const renderFrame = () => {
      animationId = requestAnimationFrame(renderFrame);
      if (!analyser) return;

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);

      const width = canvas.width / (window.devicePixelRatio || 1);
      const height = canvas.height / (window.devicePixelRatio || 1);
      ctx.clearRect(0, 0, width, height);

      // 我们只取低频到中频部分，舍弃高频，让视觉效果更集中
      const usefulBufferLength = Math.floor(bufferLength * 0.7);
      
      // 计算条宽和间距，让它们占满画布
      const totalBarWidth = width / usefulBufferLength;
      const barPadding = totalBarWidth * 0.2; // 20% 的间距
      const barWidth = totalBarWidth - barPadding;
      
      let x = barPadding / 2;

      for (let i = 0; i < usefulBufferLength; i++) {
        // 数据归一化 并稍微放大
        let barHeight = (dataArray[i] / 255) * height * 1.1;
        // 限制最大高度
        if (barHeight > height) barHeight = height;
        
        // 动态透明度：声音越大越亮
        const alpha = 0.25 + (barHeight / height) * 0.75;
        ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;

        // 绘制圆角条 (垂直居中)
        const y = (height - barHeight) / 2;
        
        if (ctx.roundRect) {
            ctx.beginPath();
            // 使用更大的圆角半径
            ctx.roundRect(x, y, barWidth, barHeight, 50);
            ctx.fill();
        } else {
            ctx.fillRect(x, y, barWidth, barHeight);
        }
        x += totalBarWidth;
      }
    };

    const resizeCanvas = () => {
      if(canvas) {
        const dpr = window.devicePixelRatio || 1;
        // 获取父容器宽度，确保填满
        const rect = canvas.parentNode.getBoundingClientRect();
        canvas.width = (rect.width - 48) * dpr; // 减去父容器padding
        canvas.height = canvas.clientHeight * dpr;
        ctx.scale(dpr, dpr);
      }
    };
    // 监听窗口调整，但也监听横竖屏切换
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);


    // ================== 播放器核心逻辑 ==================
    const initPlayer = () => {
      const params = new URLSearchParams(window.location.search);
      const idx = params.get('index');
      const t = params.get('time');
      const st = params.get('status');

      if (idx !== null) currentIndex = parseInt(idx) || 0;
      if (currentIndex < 0 || currentIndex >= songs.length) currentIndex = 0;

      loadSong(currentIndex);

      if (t && !isNaN(parseFloat(t))) audio.currentTime = parseFloat(t);
      // 如果 URL 要求播放，尝试自动播放（可能会被浏览器拦截）
      if (st === 'play') {
         // 现代浏览器通常不允许未交互的自动播放音频，所以这里只是尝试
         playMusic().catch(() => updateUI(false));
      }
    };

    const loadSong = (i) => {
      if (!songs[i]) return;
      const s = songs[i];
      audio.src = s.src;
      els.title.textContent = s.title;
      els.cover.src = s.cover;
      // 固定艺术家名称，或在数组中添加
      // els.artist.textContent = s.artist || "Elysia Collection"; 
      
      if('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
           title: s.title, artist: els.artist.textContent, artwork: [{src: s.cover, sizes: '512x512', type: 'image/jpeg'}]
        });
        navigator.mediaSession.setActionHandler('play', playMusic);
        navigator.mediaSession.setActionHandler('pause', pauseMusic);
        navigator.mediaSession.setActionHandler('previoustrack', playPrev);
        navigator.mediaSession.setActionHandler('nexttrack', playNext);
      }
    };

    const playMusic = async () => {
      // 1. 用户交互后初始化频谱
      if (!isVisualizerInited) initVisualizer();
      // 2. 恢复 AudioContext 状态
      if (audioContext && audioContext.state === 'suspended') await audioContext.resume();

      try {
        await audio.play();
        updateUI(true);
      } catch (e) {
        console.log("播放被阻止，等待用户交互", e);
        updateUI(false);
      }
    };
    
    const pauseMusic = () => { audio.pause(); updateUI(false); };
    
    const updateUI = (isPlaying) => {
      if (isPlaying) {
        els.body.classList.add('is-playing'); els.body.classList.remove('is-paused');
        els.iconPlay.style.display = 'none'; els.iconPause.style.display = 'block';
      } else {
        els.body.classList.remove('is-playing'); els.body.classList.add('is-paused');
        els.iconPlay.style.display = 'block'; els.iconPause.style.display = 'none';
      }
    };

    const playNext = () => { currentIndex = (currentIndex + 1) % songs.length; loadSong(currentIndex); playMusic(); };
    const playPrev = () => { currentIndex = (currentIndex - 1 + songs.length) % songs.length; loadSong(currentIndex); playMusic(); };

    els.playBtn.onclick = () => audio.paused ? playMusic() : pauseMusic();
    els.nextBtn.onclick = playNext;
    els.prevBtn.onclick = playPrev;

    audio.ontimeupdate = () => {
      if (!isDragging) {
        const d = audio.duration || 0;
        const ct = audio.currentTime;
        const p = d > 0 ? (ct / d) * 100 : 0;
        els.pBar.value = p;
        els.pFill.style.width = p + '%';
        els.currT.textContent = formatTime(ct);
        els.totalT.textContent = formatTime(d);
      }
    };
    
    audio.onended = playNext;
    
    // 优化拖动体验
    els.pBar.oninput = (e) => { 
        isDragging = true; 
        els.pFill.style.width = e.target.value + '%'; 
        // 拖动时实时更新时间显示（可选）
        const d = audio.duration || 0;
        els.currT.textContent = formatTime((e.target.value / 100) * d);
    };
    els.pBar.onchange = (e) => {
      isDragging = false;
      const d = audio.duration || 0;
      audio.currentTime = (e.target.value / 100) * d;
      if(audio.paused) playMusic();
    };

    const formatTime = (s) => {
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    };

    window.goBack = () => window.location.href = "index.html";

    // 页面加载完成后初始化，并尝试调整一次画布大小
    window.addEventListener('DOMContentLoaded', () => {
        initPlayer();
        setTimeout(resizeCanvas, 100); // 延时确保布局完成
    });
  </script>
</body>
</html>
