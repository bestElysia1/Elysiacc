<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Elysia Player</title>
  <style>
    :root {
      --text-main: rgba(255, 255, 255, 0.95);
      --text-sub: rgba(255, 255, 255, 0.65);
      --accent: #fff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
      background: #000;
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* === 背景层 === */
    .bg-layer {
      position: fixed;
      right: 0; bottom: 0;
      min-width: 100%; min-height: 100%;
      width: auto; height: auto;
      object-fit: cover;
      filter: blur(40px) brightness(0.7); 
      transform: scale(1.2);
    }
    #bgStatic { z-index: -3; }
    #bgVideo { z-index: -2; opacity: 0; transition: opacity 1.5s ease; }

    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.2);
      z-index: -1; pointer-events: none;
    }

    /* === 顶部导航 === */
    .nav-bar {
      position: absolute; top: 0; left: 0; right: 0;
      padding: max(20px, env(safe-area-inset-top)) 24px;
      display: flex; justify-content: space-between; align-items: center; z-index: 10;
    }
    
    .capsule-btn {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.15);
      padding: 8px 18px; border-radius: 99px;
      font-size: 14px; color: #fff; cursor: pointer; display: flex; gap: 6px; align-items: center;
    }

    /* === 主播放界面 (添加过渡以配合播放列表动画) === */
    .player-layout {
      display: flex; flex-direction: column; align-items: center;
      width: 100%; max-width: 1000px; height: 100%;
      padding: 20px; justify-content: center;
      position: relative; z-index: 1;
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.4s ease;
    }
    /* 当播放列表打开时，主界面稍微后退 */
    body.playlist-open .player-layout {
        transform: scale(0.92);
        opacity: 0.6;
    }

    @media (min-width: 768px) {
      .player-layout { flex-direction: row; gap: 60px; padding: 60px; }
      .art-section, .controls-section { flex: 1; }
    }

    /* 封面 */
    .art-section { width: 100%; display: flex; justify-content: center; margin-bottom: 30px; }
    @media (min-width: 768px) { margin-bottom: 0; }

    .album-art-wrapper {
      width: 75vw; height: 75vw; max-width: 320px; max-height: 320px;
      border-radius: 12px; position: relative;
      transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
    }
    .album-art-wrapper img {
      width: 100%; height: 100%; object-fit: cover; border-radius: 12px; display: block;
    }
    .is-playing .album-art-wrapper { transform: scale(1); }
    .is-paused .album-art-wrapper { transform: scale(0.9); opacity: 0.9; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.4); }

    /* 控制区 */
    .controls-section { width: 100%; max-width: 420px; display: flex; flex-direction: column; }
    .song-info { text-align: center; margin-bottom: 15px; }
    @media (min-width: 768px) { .song-info { text-align: left; } }
    
    .song-title { font-size: 22px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .artist-name { font-size: 16px; color: var(--text-sub); }

    /* 频谱 */
    #visualizer {
      width: 100%; height: 60px; display: block; margin-bottom: 10px; opacity: 0.85; pointer-events: none;
    }

    /* 进度条 */
    .progress-container { margin-bottom: 35px; width: 100%; }
    .slider-track { width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; position: relative; cursor: pointer; }
    .progress-fill { position: absolute; left:0; top:0; bottom:0; width:0%; background:#fff; border-radius:2px; }
    .slider-thumb {
        position: absolute; right: -6px; top: 50%; transform: translateY(-50%) scale(0);
        width: 12px; height: 12px; background: #fff; border-radius: 50%;
        transition: transform 0.2s;
    }
    .slider-track:hover .slider-thumb, .slider-track:active .slider-thumb { transform: translateY(-50%) scale(1); }
    input[type=range] { -webkit-appearance:none; position:absolute; width:100%; height:20px; top:-8px; left:0; background:transparent; z-index:2; cursor: pointer; }
    .time-labels { display:flex; justify-content:space-between; font-size:12px; color:var(--text-sub); margin-top:8px; font-weight:500; font-variant-numeric: tabular-nums; }

    /* 按钮行 */
    .controls-row { display:flex; align-items:center; justify-content: space-between; width: 100%; padding: 0 10px; }
    .ctrl-btn { background:none; border:none; color:#fff; cursor:pointer; display:flex; align-items: center; justify-content: center; transition:0.2s; opacity: 0.9; }
    .ctrl-btn:active { transform:scale(0.9); opacity: 1; }
    .ctrl-icon { width: 24px; height: 24px; fill:currentColor; }
    .ctrl-btn.side-btn .ctrl-icon { width: 20px; height: 20px; opacity: 0.7; }
    .ctrl-btn.side-btn:hover .ctrl-icon { opacity: 1; }
    .btn-play-pause { width:64px; height:64px; background:#fff; color:#000; border-radius:50%; box-shadow:0 8px 20px rgba(255,255,255,0.25); opacity: 1; }
    .btn-play-pause:hover { transform: scale(1.05); }
    .btn-play-pause:active { transform: scale(0.95); }
    .btn-play-pause .ctrl-icon { width:28px; height:28px; fill: #000; }

    /* === 播放列表弹窗 (动画优化版) === */
    .playlist-drawer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0); /* 背景色动画单独控制 */
        z-index: 100;
        pointer-events: none;
        display: flex; flex-direction: column; justify-content: flex-end;
        transition: background 0.4s ease;
    }
    .playlist-drawer.active { 
        pointer-events: auto;
        background: rgba(0,0,0,0.4); 
    }

    .playlist-content {
        background: rgba(30, 30, 30, 0.9);
        backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
        width: 100%; max-height: 65vh;
        border-radius: 24px 24px 0 0; padding: 24px 24px 40px 24px;
        display: flex; flex-direction: column; border-top: 1px solid rgba(255,255,255,0.1);
        
        /* 核心动画：弹簧效果 */
        transform: translateY(110%); 
        transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
    }
    .playlist-drawer.active .playlist-content { transform: translateY(0); }

    .playlist-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .playlist-close { 
        font-size: 14px; color: var(--text-sub); cursor: pointer; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 20px; 
    }
    
    .song-list { overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1; }

    /* 列表项动画 */
    .list-item { 
        display: flex; align-items: center; gap: 12px; padding: 12px 0; 
        border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; 
        
        /* 初始状态：下沉且透明 */
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    
    /* 当列表打开时，列表项变为可见 (延迟由 JS 控制) */
    .playlist-drawer.active .list-item {
        opacity: 1;
        transform: translateY(0);
    }
    
    .list-item:last-child { border-bottom: none; }
    .list-item.active .item-title { color: var(--accent); font-weight: bold; }
    .list-item.active .item-idx { color: var(--accent); }
    .item-idx { font-size: 12px; color: var(--text-sub); width: 20px; }
    .item-info { display: flex; flex-direction: column; }
    .item-title { font-size: 15px; margin-bottom: 2px; }
    .item-artist { font-size: 12px; color: var(--text-sub); }

    /* Toast */
    .toast {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9); color: #000;
        padding: 10px 20px; border-radius: 20px; font-weight: 600;
        opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200;
    }
  </style>
</head>
<body class="is-paused">

  <img id="bgStatic" class="bg-layer" src="assets/bg.jpg" alt="Background">
  <video id="bgVideo" class="bg-layer" autoplay muted loop playsinline>
    <source src="assets/bg.mp4" type="video/mp4">
  </video>

  <div class="overlay"></div>
  <div id="toast" class="toast">Mode Changed</div>

  <nav class="nav-bar">
    <button class="capsule-btn" onclick="goBack()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
      Back
    </button>
  </nav>

  <main class="player-layout">
    <section class="art-section">
      <div class="album-art-wrapper">
        <img id="coverImg" src="" alt="Album Art">
      </div>
    </section>

    <section class="controls-section">
      <div class="song-info">
        <div class="song-title" id="songTitle">Elysia</div>
        <div class="artist-name">Loading...</div>
      </div>

      <canvas id="visualizer"></canvas>

      <div class="progress-container">
        <div class="slider-track" id="trackArea">
          <div class="progress-fill" id="progressFill"></div>
          <div class="slider-thumb" id="thumb"></div>
          <input type="range" id="progressBar" min="0" value="0" step="0.1">
        </div>
        <div class="time-labels">
          <span id="currTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
      </div>

      <div class="controls-row">
        <button class="ctrl-btn side-btn" id="modeBtn" title="Play Mode">
          <svg class="ctrl-icon" id="iconLoop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
          <svg class="ctrl-icon" id="iconOne" style="display:none" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/></svg>
          <svg class="ctrl-icon" id="iconShuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
        </button>
        <button class="ctrl-btn" id="prevBtn"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="ctrl-btn btn-play-pause" id="playBtn">
          <svg class="ctrl-icon" id="iconPlay" style="display:block" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="ctrl-icon" id="iconPause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="ctrl-btn" id="nextBtn"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
        <button class="ctrl-btn side-btn" id="listBtn" title="Playlist"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
      </div>
    </section>
  </main>

  <div id="playlistDrawer" class="playlist-drawer">
    <div class="playlist-content" onclick="event.stopPropagation()">
        <div class="playlist-header"><span>Current Playlist</span><span class="playlist-close" onclick="closePlaylist()">Close</span></div>
        <div class="song-list" id="songListContainer"></div>
    </div>
  </div>

  <script>
    // ================== 处理视频加载 ==================
    const bgVideo = document.getElementById('bgVideo');
    bgVideo.addEventListener('canplay', () => { bgVideo.style.opacity = 1; });
    if (bgVideo.readyState >= 3) { bgVideo.style.opacity = 1; }

    // ================== 音乐数据 ==================
    const songs = [
      { title: "My Soul, Your Beats!", src: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.mp3", cover: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.jpg" },
      { title: "My Most Precious Treasure", src: "assets/My Most Precious Treasure (From My Most Precious Treasure).mp3", cover: "assets/Key anime piano medley.jpg" },
      { title: "Duvert 四季 Merry mixed", src: "assets/mix.mp3", cover: "assets/Elysia11.jpg" }
    ];

    const audio = new Audio();
    audio.crossOrigin = "anonymous";
    // 关键：确保移动端后台播放权限
    audio.playsInline = true; 
    
    let currentIndex = 0;
    let isDragging = false;
    let playMode = 0;
    
    // 频谱变量
    let audioContext, analyser, source;
    let canvas, ctx, isVisualizerInited = false;
    let animationId; // 记录动画帧ID，方便恢复

    const els = {
      body: document.body, cover: document.getElementById('coverImg'),
      title: document.getElementById('songTitle'), artist: document.querySelector('.artist-name'),
      playBtn: document.getElementById('playBtn'), prevBtn: document.getElementById('prevBtn'), nextBtn: document.getElementById('nextBtn'),
      modeBtn: document.getElementById('modeBtn'), listBtn: document.getElementById('listBtn'),
      pFill: document.getElementById('progressFill'), pBar: document.getElementById('progressBar'), thumb: document.getElementById('thumb'),
      currT: document.getElementById('currTime'), totalT: document.getElementById('totalTime'),
      iconPlay: document.getElementById('iconPlay'), iconPause: document.getElementById('iconPause'),
      drawer: document.getElementById('playlistDrawer'), listContainer: document.getElementById('songListContainer'),
      toast: document.getElementById('toast'),
      iconLoop: document.getElementById('iconLoop'), iconOne: document.getElementById('iconOne'), iconShuffle: document.getElementById('iconShuffle')
    };

    // ================== 修复：后台播放逻辑 ==================
    // 监听页面的可见性变化
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            // 切回前台：如果 AudioContext 被挂起，则恢复它
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            // 确保 Canvas 动画继续
            cancelAnimationFrame(animationId);
            renderFrame();
        }
    });

    // ================== 频谱 ==================
    const initVisualizer = () => {
      if (isVisualizerInited) return;
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 1024; 
        
        // 注意：createMediaElementSource 会将 audio 的输出重定向到 AudioContext
        // 如果 AudioContext 挂起，声音就会消失。
        source = audioContext.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        
        canvas = document.getElementById('visualizer');
        ctx = canvas.getContext('2d');
        resizeCanvas();
        isVisualizerInited = true;
        renderFrame();
      } catch (e) { console.warn("Visualizer init warning:", e); }
    };

    const renderFrame = () => {
      animationId = requestAnimationFrame(renderFrame);
      if (!analyser) return;
      
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);

      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const barWidth = w / bufferLength;
      let x = 0;
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; 

      for (let i = 0; i < bufferLength; i++) {
        let barHeight = h * (dataArray[i] / 255) * 0.9;
        if (barHeight < 1) barHeight = 0;
        const y = (h - barHeight) / 2;
        let drawWidth = barWidth > 2 ? barWidth - 1 : barWidth;
        
        ctx.beginPath();
        if (barHeight > 4 && ctx.roundRect) ctx.roundRect(x, y, drawWidth, barHeight, 5);
        else ctx.fillRect(x, y, drawWidth, barHeight);
        
        x += barWidth;
      }
    };

    const resizeCanvas = () => {
      if(canvas) {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
      }
    };
    window.addEventListener('resize', resizeCanvas);

    // ================== 播放器逻辑 ==================
    const initPlayer = () => {
      const params = new URLSearchParams(window.location.search);
      const idx = params.get('index');
      if (idx !== null) currentIndex = parseInt(idx) || 0;
      loadSong(currentIndex);
    };

    const loadSong = (i) => {
      if (!songs[i]) return;
      const s = songs[i];
      audio.src = s.src;
      els.title.textContent = s.title;
      els.cover.src = s.cover;
      els.artist.textContent = "Elysia Collection";
      // 此时不渲染列表，等打开时渲染以获得动画效果
      
      if('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({ title: s.title, artist: 'Elysia Collection', artwork: [{src: s.cover, sizes: '512x512', type: 'image/jpeg'}] });
        navigator.mediaSession.setActionHandler('play', playMusic);
        navigator.mediaSession.setActionHandler('pause', pauseMusic);
        navigator.mediaSession.setActionHandler('previoustrack', playPrev);
        navigator.mediaSession.setActionHandler('nexttrack', playNextAuto);
      }
    };

    const playMusic = () => {
      if (!isVisualizerInited) initVisualizer();
      
      // 强行恢复 context，防止后台切换回来后没声音
      if (audioContext && audioContext.state === 'suspended') audioContext.resume();
      
      audio.play().then(() => updateUI(true)).catch(e => {
          console.warn("Play failed:", e);
          updateUI(false);
      });
    };
    const pauseMusic = () => { audio.pause(); updateUI(false); };
    
    const updateUI = (isPlaying) => {
      if (isPlaying) { els.body.classList.add('is-playing'); els.body.classList.remove('is-paused'); els.iconPlay.style.display = 'none'; els.iconPause.style.display = 'block'; } 
      else { els.body.classList.remove('is-playing'); els.body.classList.add('is-paused'); els.iconPlay.style.display = 'block'; els.iconPause.style.display = 'none'; }
    };

    const playNextAuto = () => {
        if (playMode === 1) { audio.currentTime = 0; playMusic(); }
        else if (playMode === 2) { 
            let nextIndex = currentIndex;
            while(nextIndex === currentIndex && songs.length > 1) nextIndex = Math.floor(Math.random() * songs.length);
            currentIndex = nextIndex; loadSong(currentIndex); playMusic();
        } else { playNext(); }
    };
    const playNext = () => { 
        if (playMode === 2) { 
             let nextIndex = currentIndex;
            while(nextIndex === currentIndex && songs.length > 1) nextIndex = Math.floor(Math.random() * songs.length);
            currentIndex = nextIndex;
        } else { currentIndex = (currentIndex + 1) % songs.length; }
        loadSong(currentIndex); playMusic(); 
    };
    const playPrev = () => { if (audio.currentTime > 3) audio.currentTime = 0; else { currentIndex = (currentIndex - 1 + songs.length) % songs.length; loadSong(currentIndex); } playMusic(); };
    
    const toggleMode = () => {
        playMode = (playMode + 1) % 3;
        els.iconLoop.style.display = playMode === 0 ? 'block' : 'none';
        els.iconOne.style.display = playMode === 1 ? 'block' : 'none';
        els.iconShuffle.style.display = playMode === 2 ? 'block' : 'none';
        const modes = ["Loop All", "Loop One", "Shuffle"];
        showToast(modes[playMode]);
    };
    const showToast = (msg) => { els.toast.textContent = msg; els.toast.style.opacity = '1'; setTimeout(() => els.toast.style.opacity = '0', 1500); }

    els.playBtn.onclick = () => audio.paused ? playMusic() : pauseMusic();
    els.nextBtn.onclick = playNext; els.prevBtn.onclick = playPrev; els.modeBtn.onclick = toggleMode;
    audio.onended = playNextAuto;
    
    audio.ontimeupdate = () => {
      if (!isDragging) {
        const d = audio.duration || 0; const ct = audio.currentTime; const p = d > 0 ? (ct / d) * 100 : 0;
        els.pBar.value = p; els.pFill.style.width = p + '%';
        els.thumb.style.transform = `translateY(-50%) scale(${p > 0 ? 1 : 0})`; els.thumb.style.left = p + '%';
        els.currT.textContent = formatTime(ct); els.totalT.textContent = formatTime(d);
      }
    };
    els.pBar.oninput = (e) => { isDragging = true; els.pFill.style.width = e.target.value + '%'; els.thumb.style.left = e.target.value + '%'; els.thumb.style.transform = `translateY(-50%) scale(1)`; };
    els.pBar.onchange = (e) => { isDragging = false; audio.currentTime = (e.target.value / 100) * (audio.duration || 0); if(audio.paused) playMusic(); };
    const formatTime = (s) => { const m = Math.floor(s / 60), sec = Math.floor(s % 60); return `${m}:${sec < 10 ? '0' : ''}${sec}`; };

    // ================== 列表动画优化 ==================
    const openPlaylist = () => { 
        renderPlaylist(); // 先渲染内容
        els.body.classList.add('playlist-open'); // 主界面后退效果
        els.drawer.classList.add('active'); 
    };
    window.closePlaylist = () => {
        els.body.classList.remove('playlist-open');
        els.drawer.classList.remove('active'); 
    };
    els.drawer.addEventListener('click', (e) => { if (e.target === els.drawer) closePlaylist(); });
    els.listBtn.onclick = openPlaylist;

    const renderPlaylist = () => {
        els.listContainer.innerHTML = '';
        songs.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = `list-item ${i === currentIndex ? 'active' : ''}`;
            
            // 关键：设置延迟，制造瀑布流效果 (Stagger Animation)
            // 每个项目比前一个晚 0.05秒出现
            div.style.transitionDelay = `${i * 0.05}s`; 

            div.innerHTML = `<span class="item-idx">${i === currentIndex ? '♫' : (i+1)}</span><div class="item-info"><span class="item-title">${s.title}</span><span class="item-artist">Elysia Collection</span></div>`;
            div.onclick = () => { if (i !== currentIndex) { currentIndex = i; loadSong(currentIndex); } playMusic(); window.closePlaylist(); };
            els.listContainer.appendChild(div);
        });
    };
    
    window.goBack = () => window.location.href = "index.html";
    initPlayer();
  </script>
</body>
</html>
