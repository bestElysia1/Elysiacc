<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Elysia Player</title>
  <style>
    :root {
      --text-main: rgba(255, 255, 255, 0.95);
      --text-sub: rgba(255, 255, 255, 0.65);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      background: #000;
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* === 视频背景 === */
    #bgVideo {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%; 
      min-height: 100%;
      width: auto; 
      height: auto;
      z-index: -2;
      object-fit: cover;
      filter: blur(40px) brightness(0.8); 
      transform: scale(1.2);
    }

    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.15);
      z-index: -1;
      pointer-events: none;
    }

    /* === UI 布局 === */
    .nav-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: max(20px, env(safe-area-inset-top)) 24px;
      display: flex; justify-content: space-between; align-items: center; z-index: 10;
    }
    
    .capsule-btn {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.15);
      padding: 8px 18px; border-radius: 99px;
      font-size: 14px; color: #fff; cursor: pointer; display: flex; gap: 6px; align-items: center;
    }

    .player-layout {
      display: flex; flex-direction: column; align-items: center;
      width: 100%; max-width: 1000px; height: 100%;
      padding: 20px; justify-content: center;
    }
    @media (min-width: 768px) {
      .player-layout { flex-direction: row; gap: 60px; padding: 60px; }
      .art-section, .controls-section { flex: 1; }
    }

    /* 封面 */
    .art-section { width: 100%; display: flex; justify-content: center; margin-bottom: 20px; }
    @media (min-width: 768px) { margin-bottom: 0; }

    .album-art-wrapper {
      width: 80vw; height: 80vw; max-width: 340px; max-height: 340px;
      border-radius: 16px; position: relative;
      transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    .album-art-wrapper img {
      width: 100%; height: 100%; object-fit: cover; border-radius: 16px; display: block;
    }
    .is-playing .album-art-wrapper { transform: scale(1); }
    .is-paused .album-art-wrapper { transform: scale(0.85); box-shadow: none; opacity: 0.8; }

    /* 控制区 */
    .controls-section { width: 100%; max-width: 450px; display: flex; flex-direction: column; }
    .song-info { text-align: center; margin-bottom: 5px; } /* 减小间距给频谱腾位置 */
    @media (min-width: 768px) { .song-info { text-align: left; } }
    
    .song-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .artist-name { font-size: 17px; color: var(--text-sub); }

    /* === 新增：频谱画布样式 === */
    #visualizer {
      width: 100%;
      height: 50px; /* 控制频谱高度 */
      display: block;
      margin-bottom: 25px; /* 与进度条的距离 */
      opacity: 0.9;
    }

    /* 进度条 */
    .progress-container { margin-bottom: 40px; width: 100%; }
    .slider-track { width: 100%; height: 5px; background: rgba(255,255,255,0.15); border-radius: 10px; position: relative; }
    .progress-fill { position: absolute; left:0; top:0; bottom:0; width:0%; background:#fff; border-radius:10px; }
    input[type=range] { -webkit-appearance:none; position:absolute; width:100%; height:20px; top:-8px; left:0; background:transparent; z-index:2; }
    .time-labels { display:flex; justify-content:space-between; font-size:12px; color:var(--text-sub); margin-top:10px; font-weight:600; font-variant-numeric: tabular-nums; }

    /* 按钮 */
    .controls-row { display:flex; align-items:center; justify-content:center; gap:40px; }
    .ctrl-btn { background:none; border:none; color:#fff; cursor:pointer; display:flex; transition:0.2s; }
    .ctrl-btn:active { transform:scale(0.85); }
    .ctrl-icon { width:32px; height:32px; fill:currentColor; }
    .btn-play-pause { width:70px; height:70px; background:#fff; color:#000; border-radius:50%; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(255,255,255,0.2); }
    .btn-play-pause .ctrl-icon { width:28px; height:28px; }
  </style>
</head>
<body class="is-paused">

  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="assets/bg.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <nav class="nav-bar">
    <button class="capsule-btn" onclick="goBack()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
      Back
    </button>
  </nav>

  <main class="player-layout">
    <section class="art-section">
      <div class="album-art-wrapper">
        <img id="coverImg" src="" alt="Album Art">
      </div>
    </section>

    <section class="controls-section">
      <div class="song-info">
        <div class="song-title" id="songTitle">Elysia</div>
        <div class="artist-name">Loading...</div>
      </div>

      <canvas id="visualizer"></canvas>
      <div class="progress-container">
        <div class="slider-track">
          <div class="progress-fill" id="progressFill"></div>
          <input type="range" id="progressBar" min="0" value="0" step="0.1">
        </div>
        <div class="time-labels">
          <span id="currTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
      </div>

      <div class="controls-row">
        <button class="ctrl-btn" id="prevBtn"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="ctrl-btn btn-play-pause" id="playBtn">
          <svg class="ctrl-icon" id="iconPlay" style="display:block" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="ctrl-icon" id="iconPause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="ctrl-btn" id="nextBtn"><svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
      </div>
    </section>
  </main>

  <script>
    // ================== 音乐数据 ==================
    const songs = [
      { title: "My Soul, Your Beats!", src: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.mp3", cover: "assets/My Soul, Your Beats! -Piano Arrange Ver.-.jpg" },
      { title: "My Most Precious Treasure", src: "assets/My Most Precious Treasure (From My Most Precious Treasure).mp3", cover: "assets/Key anime piano medley.jpg" },
      { title: "Duvert 四季 Merry mixed", src: "assets/mix.mp3", cover: "assets/Elysia11.jpg" }
    ];

    // 初始化音频对象，设置跨域许可（重要）
    const audio = new Audio();
    audio.crossOrigin = "anonymous";

    let currentIndex = 0;
    let isDragging = false;
    
    // === 频谱相关变量 ===
    let audioContext, analyser, source;
    let canvas, ctx;
    let isVisualizerInited = false;
    let animationId;

    const els = {
      body: document.body, cover: document.getElementById('coverImg'),
      title: document.getElementById('songTitle'), artist: document.querySelector('.artist-name'),
      playBtn: document.getElementById('playBtn'), prevBtn: document.getElementById('prevBtn'), nextBtn: document.getElementById('nextBtn'),
      pFill: document.getElementById('progressFill'), pBar: document.getElementById('progressBar'),
      currT: document.getElementById('currTime'), totalT: document.getElementById('totalTime'),
      iconPlay: document.getElementById('iconPlay'), iconPause: document.getElementById('iconPause')
    };

    // ================== 频谱可视化逻辑 ==================
    const initVisualizer = () => {
      if (isVisualizerInited) return;

      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        analyser = audioContext.createAnalyser();
        // fftSize 决定条的数量 (值越大条越细: 64, 128, 256)
        analyser.fftSize = 128; 

        // 连接音频源
        source = audioContext.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioContext.destination);

        // 初始化画布
        canvas = document.getElementById('visualizer');
        ctx = canvas.getContext('2d');
        resizeCanvas(); // 调整初始大小

        isVisualizerInited = true;
        renderFrame();
      } catch (e) {
        console.warn("Visualizer init failed (likely CORS or browser policy):", e);
      }
    };

    const renderFrame = () => {
      animationId = requestAnimationFrame(renderFrame);

      if (!analyser) return;

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);

      // 清除画布
      const width = canvas.width / (window.devicePixelRatio || 1);
      const height = canvas.height / (window.devicePixelRatio || 1);
      ctx.clearRect(0, 0, width, height);

      // 绘制参数
      const barWidth = (width / bufferLength) * 2.5; // 间距系数
      let barHeight;
      let x = 0;

      for (let i = 0; i < bufferLength; i++) {
        // 让高度变化平滑一些
        barHeight = (dataArray[i] / 255) * height * 0.9;
        
        // 动态透明度：声音越大越亮
        ctx.fillStyle = `rgba(255, 255, 255, ${0.3 + (barHeight/height) * 0.7})`;

        // 绘制圆角条 (垂直居中)
        const y = (height - barHeight) / 2;
        
        // 兼容性写法绘制圆角矩形
        if (ctx.roundRect) {
            ctx.beginPath();
            ctx.roundRect(x, y, barWidth - 2, barHeight, 50);
            ctx.fill();
        } else {
            ctx.fillRect(x, y, barWidth - 2, barHeight);
        }

        x += barWidth;
      }
    };

    const resizeCanvas = () => {
      if(canvas) {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
      }
    };
    window.addEventListener('resize', resizeCanvas);

    // ================== 播放器核心逻辑 ==================
    const initPlayer = () => {
      const params = new URLSearchParams(window.location.search);
      const idx = params.get('index');
      const t = params.get('time');
      const st = params.get('status');

      if (idx !== null) currentIndex = parseInt(idx) || 0;
      if (currentIndex < 0 || currentIndex >= songs.length) currentIndex = 0;

      loadSong(currentIndex);

      if (t && !isNaN(parseFloat(t))) audio.currentTime = parseFloat(t);
      if (st === 'play') setTimeout(() => playMusic(), 150);
    };

    const loadSong = (i) => {
      if (!songs[i]) return;
      const s = songs[i];
      audio.src = s.src;
      els.title.textContent = s.title;
      els.cover.src = s.cover;
      els.artist.textContent = "Elysia Collection";
      
      if('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
           title: s.title, artist: 'Elysia Collection', artwork: [{src: s.cover, sizes: '512x512', type: 'image/jpeg'}]
        });
        navigator.mediaSession.setActionHandler('play', playMusic);
        navigator.mediaSession.setActionHandler('pause', pauseMusic);
        navigator.mediaSession.setActionHandler('previoustrack', playPrev);
        navigator.mediaSession.setActionHandler('nexttrack', playNext);
      }
    };

    const playMusic = () => {
      // 1. 尝试初始化频谱（如果是第一次点击）
      if (!isVisualizerInited) initVisualizer();
      
      // 2. 恢复 AudioContext（浏览器要求必须在用户交互中 resume）
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }

      // 3. 播放
      audio.play().then(() => updateUI(true)).catch(e => {
        updateUI(false);
      });
    };
    
    const pauseMusic = () => { audio.pause(); updateUI(false); };
    
    const updateUI = (isPlaying) => {
      if (isPlaying) {
        els.body.classList.add('is-playing'); els.body.classList.remove('is-paused');
        els.iconPlay.style.display = 'none'; els.iconPause.style.display = 'block';
      } else {
        els.body.classList.remove('is-playing'); els.body.classList.add('is-paused');
        els.iconPlay.style.display = 'block'; els.iconPause.style.display = 'none';
      }
    };

    const playNext = () => { currentIndex = (currentIndex + 1) % songs.length; loadSong(currentIndex); playMusic(); };
    const playPrev = () => { currentIndex = (currentIndex - 1 + songs.length) % songs.length; loadSong(currentIndex); playMusic(); };

    els.playBtn.onclick = () => audio.paused ? playMusic() : pauseMusic();
    els.nextBtn.onclick = playNext;
    els.prevBtn.onclick = playPrev;

    audio.ontimeupdate = () => {
      if (!isDragging) {
        const d = audio.duration || 0;
        const ct = audio.currentTime;
        const p = d > 0 ? (ct / d) * 100 : 0;
        els.pBar.value = p;
        els.pFill.style.width = p + '%';
        els.currT.textContent = formatTime(ct);
        els.totalT.textContent = formatTime(d);
      }
    };
    
    audio.onended = playNext;
    
    els.pBar.oninput = (e) => { isDragging = true; els.pFill.style.width = e.target.value + '%'; };
    els.pBar.onchange = (e) => {
      isDragging = false;
      const d = audio.duration || 0;
      audio.currentTime = (e.target.value / 100) * d;
      if(audio.paused) playMusic();
    };

    const formatTime = (s) => {
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    };

    window.goBack = () => window.location.href = "index.html";

    initPlayer();
  </script>
</body>
</html>
